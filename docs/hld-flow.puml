@startuml HLD-Flow
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

LAYOUT_LEFT_RIGHT()
HIDE_STEREOTYPE()

title Processamento de Vídeo - Arquitetura Final\n(EventBridge + SQS + KEDA)

' =====================================
' LEGENDA
' =====================================
legend right
  |= Cor |= Tipo |
  | <#438DD5> | AWS Services |
  | <#1168BD> | API / Backend |
  | <#999999> | Kubernetes |
  | <#FF9900> | Banco de Dados |
endlegend

' =====================================
' ACTORS
' =====================================
Person(user, "Usuário", "Envia vídeos para processamento")

' =====================================
' FASE 1: AUTENTICAÇÃO
' =====================================
System_Boundary(auth, "1. Autenticação") {
    Container(cognito, "Cognito", "AWS", "Auth OTP")
}

' =====================================
' FASE 2: API
' =====================================
System_Boundary(api, "2. FIAPX API") {
    Container(apiVideos, "POST /videos", "Elysia", "Cria vídeo")
    Container(apiUrls, "GET /upload-urls", "Elysia", "Batch 20 URLs")
    Container(apiParts, "POST /parts/{n}", "Elysia", "Reporta ETag")
    Container(apiComplete, "POST /complete", "Elysia", "Finaliza upload")
}

' =====================================
' FASE 3: STORAGE
' =====================================
System_Boundary(storage, "3. Storage") {
    ContainerDb(s3Videos, "S3 Videos", "S3", "Vídeos originais")
    ContainerDb(s3Frames, "S3 Frames", "S3", "Frames extraídos")
}

' =====================================
' FASE 4: EVENTOS
' =====================================
System_Boundary(events, "4. Event Bus") {
    Container(eventbridge, "EventBridge", "AWS", "Roteamento")
    ContainerQueue(sqsSplit, "SQS Split", "SQS", "Fila split")
    ContainerQueue(sqsPrint, "SQS Print", "SQS", "Fila print")
}

' =====================================
' FASE 5: PROCESSAMENTO
' =====================================
System_Boundary(processing, "5. Kubernetes") {
    Container(kedaSplit, "Split Worker", "KEDA", "Consome SQS")
    Container(kedaPrint, "Print Worker", "KEDA", "Consome SQS")
    Container(jobSplit, "FFmpeg Split", "Job", "Divide vídeo")
    Container(jobPrint, "FFmpeg Print", "Job", "Extrai frames")
}

' =====================================
' FASE 6: NOTIFICAÇÃO
' =====================================
System_Boundary(notify, "6. Notificações") {
    Container(sns, "SNS", "AWS", "Fanout")
    Container(lambdaEmail, "Lambda Email", "Lambda", "Envia email")
    Container(lambdaSms, "Lambda SMS", "Lambda", "Envia SMS")
}

' =====================================
' DATABASE
' =====================================
ContainerDb(cassandra, "Cassandra", "DB", "Status vídeo")

' =====================================
' FLUXOS PRINCIPAIS
' =====================================

' Auth
Rel(user, cognito, "0. Login OTP")
Rel(cognito, user, "JWT")

' Upload Flow
Rel(user, apiVideos, "1. Cria vídeo")
Rel(apiVideos, s3Videos, "CreateMultipartUpload")
Rel(apiVideos, cassandra, "CREATED")

Rel(user, apiUrls, "2. Solicita URLs")
Rel(apiUrls, s3Videos, "getSignedUrl")
Rel(apiUrls, cassandra, "UPLOADING")

Rel(user, s3Videos, "3. Upload partes")
Rel(user, apiParts, "4. Reporta ETag")
Rel(apiParts, cassandra, "Atualiza parte")

Rel(user, apiComplete, "5. Finaliza")
Rel(apiComplete, s3Videos, "CompleteMultipart")

' Event Flow
Rel(s3Videos, eventbridge, "6. Object Created")
Rel(eventbridge, sqsSplit, "Publica")

' Processing Flow
Rel(sqsSplit, kedaSplit, "7. Poll")
Rel(kedaSplit, jobSplit, "Cria Job")
Rel(jobSplit, s3Videos, "Download")
Rel(jobSplit, sqsPrint, "Segmentos")
Rel(jobSplit, cassandra, "SPLITTING")

Rel(sqsPrint, kedaPrint, "8. Poll")
Rel(kedaPrint, jobPrint, "Cria Job")
Rel(jobPrint, s3Frames, "Salva frames")
Rel(jobPrint, cassandra, "PRINTING")

' Notification Flow
Rel(s3Frames, eventbridge, "9. Frames OK")
Rel(eventbridge, sns, "Publica")
Rel(sns, lambdaEmail, "10. Invoke")
Rel(sns, lambdaSms, "Invoke")
Rel_Back(cassandra, apiComplete, "COMPLETED")

@enduml
