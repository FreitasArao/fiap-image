@startuml HLD-Flow
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
!theme C4_brown from https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/themes

LAYOUT_TOP_DOWN()

title Processamento de Vídeo - Fluxo Completo + Auth OTP (Cognito)

' =====================================
' FRONTEND
' =====================================
System_Boundary(frontend, "Frontend") {
    Person(user, "Usuário", "Envia e processa vídeos")
}

' =====================================
' AUTH (FORA DA APLICAÇÃO)
' =====================================
System_Boundary(auth, "AWS Auth") {
    Container_Ext(apiGateway, "API Gateway", "AWS", "Gateway público")
    Container_Ext(cognito, "Cognito User Pool", "AWS", "Auth OTP por email")

    Container_Ext(lambdaDefine, "Lambda DefineAuth", "Lambda", "Controla desafio")
    Container_Ext(lambdaCreate, "Lambda CreateAuth", "Lambda", "Gera e envia OTP")
    Container_Ext(lambdaVerify, "Lambda VerifyAuth", "Lambda", "Valida OTP")
}

' =====================================
' API FIAPX
' =====================================
Enterprise_Boundary(fiapx, "FIAPX API") {
    Container(createURL, "/create-url", "API", "Cria URLs pré-assinadas")
    Container(processVideo, "/process-video/{video_id}", "API", "Processa upload de parte")
    Container(completeUpload, "/{video_id}", "API", "Finaliza upload multipart")
    Container(printCompleted, "/print-video/{video_id}/part/{part}", "API", "Notifica impressão")
}

' =====================================
' AWS S3
' =====================================
System_Boundary(awsS3, "AWS S3") {
    Container_Ext(s3PreSigned, "S3 Pre-Signed URLs", "S3", "Upload direto")
    Container_Ext(s3PartUpload, "S3 Part Upload", "S3", "Recebe partes")
    Container_Ext(s3Complete, "S3 Complete Multipart", "S3", "Evento de finalização")
    Container_Ext(s3Images, "S3 Images Bucket", "S3", "Armazena prints")
}

' =====================================
' AWS EVENTBRIDGE
' =====================================
System_Boundary(awsEvents, "AWS EventBridge") {
    Container_Ext(eventBridge, "EventBridge", "Events", "Roteamento")
    Container_Ext(apiDestProcess, "API Dest: Process", "Rule", "POST /process-video/{video_id}")
    Container_Ext(apiDestComplete, "API Dest: Complete", "Rule", "POST /{video_id}")
    Container_Ext(apiDestPrint, "API Dest: Print", "Rule", "POST /print-video/{video_id}/part/{part}")
}

' =====================================
' AWS SQS
' =====================================
System_Boundary(awsSQS, "AWS SQS") {
    SystemQueue(sqsSplitVideo, "SQS Split Video", "Fila divisão")
    SystemQueue(sqsPrintVideo, "SQS Print Video", "Fila impressão")
    SystemQueue(sqsDLQ, "SQS DLQ", "Dead Letter Queue")
}

' =====================================
' AWS SNS
' =====================================
System_Boundary(awsSNS, "AWS SNS") {
    Container_Ext(snsPrintCompleted, "SNS Print Completed", "Topic", "Evento final")
    SystemQueue(sqsEmail, "SQS Email Queue", "Emails")
    SystemQueue(sqsSMS, "SQS SMS Queue", "SMS")
}

' =====================================
' KUBERNETES
' =====================================
System_Boundary(k8s, "Kubernetes Cluster") {
    Container_Boundary(workers, "Workers") {
        Container_Ext(splitWorker, "Split Worker", "K8s", "Consome SQS Split")
        Container_Ext(printWorker, "Print Worker", "K8s", "Consome SQS Print")
    }
    Container_Boundary(jobs, "Jobs") {
        Container_Ext(jobSplit, "Job: Split Video", "K8s Job", "Divide vídeo")
        Container_Ext(jobPrint, "Job: Print Video", "K8s Job", "Gera prints")
    }
}

' =====================================
' CONSUMERS
' =====================================
Enterprise_Boundary(consumers, "FIAPX Consumers") {
    Container(emailConsumer, "Email Consumer", "API", "Envia email")
    Container(smsConsumer, "SMS Consumer", "API", "Envia SMS")
}

' =====================================
' DATABASE
' =====================================
System_Boundary(database, "Database") {
    SystemDb_Ext(db, "Cassandra DB", "Status do vídeo")
}

' =====================================
' FLUXO 0: AUTENTICAÇÃO OTP
' =====================================
Rel(user, apiGateway, "0. POST /auth/login")
Rel(apiGateway, cognito, "Inicia Custom Auth")
Rel(cognito, lambdaDefine, "DefineAuthChallenge")
Rel(cognito, lambdaCreate, "CreateAuthChallenge (envia OTP)")
Rel(user, apiGateway, "Envia código OTP")
Rel(apiGateway, cognito, "RespondToAuthChallenge")
Rel(cognito, lambdaVerify, "VerifyAuthChallenge")
Rel(cognito, user, "Retorna JWT")

' =====================================
' FLUXO 1: CRIAÇÃO DE URL
' =====================================
Rel(user, createURL, "1. POST /create-url", "JWT")
Rel(createURL, db, "2. Salva video_id")
Rel(createURL, s3PreSigned, "3. Retorna URLs")

' =====================================
' FLUXO 2: UPLOAD DAS PARTES
' =====================================
Rel(user, s3PreSigned, "4. Upload S3")
Rel(s3PreSigned, s3PartUpload, "5. Upload partes")

' =====================================
' FLUXO 3: PROCESSAMENTO DE PARTE
' =====================================
Rel(s3PartUpload, eventBridge, "6. Evento PartUploaded")
Rel(eventBridge, apiDestProcess, "7. Rule")
Rel(apiDestProcess, processVideo, "8. POST")
Rel(processVideo, db, "9. Status → processing")

' =====================================
' FLUXO 4: FINALIZAÇÃO
' =====================================
Rel(s3Complete, eventBridge, "10. Evento Complete")
Rel(eventBridge, apiDestComplete, "11. Rule")
Rel(apiDestComplete, completeUpload, "12. POST")
Rel(completeUpload, db, "13. Status → printing")
Rel(completeUpload, sqsSplitVideo, "14. Publica")

' =====================================
' FLUXO 5: SPLIT
' =====================================
Rel(sqsSplitVideo, splitWorker, "15. Consome")
Rel(splitWorker, jobSplit, "16. Job")
Rel(jobSplit, sqsPrintVideo, "17. Publica")

' =====================================
' FLUXO 6: PRINT
' =====================================
Rel(sqsPrintVideo, printWorker, "18. Consome")
Rel(printWorker, jobPrint, "19. Job")
Rel(jobPrint, s3Images, "20. Armazena")

' =====================================
' FLUXO 7: NOTIFICAÇÃO
' =====================================
Rel(s3Images, eventBridge, "21. Evento")
Rel(eventBridge, apiDestPrint, "22. Rule")
Rel(apiDestPrint, printCompleted, "23. POST")
Rel(printCompleted, db, "24. Status → completed")
Rel(printCompleted, snsPrintCompleted, "25. Publica")

' =====================================
' FLUXO 8: FANOUT
' =====================================
Rel(snsPrintCompleted, sqsEmail, "26. Email")
Rel(snsPrintCompleted, sqsSMS, "27. SMS")
Rel(sqsEmail, emailConsumer, "28. Envia")
Rel(sqsSMS, smsConsumer, "29. Envia")

' =====================================
' DLQ
' =====================================
Rel(sqsSplitVideo, sqsDLQ, "Falha")
Rel(sqsPrintVideo, sqsDLQ, "Falha")

@enduml
