@startuml HLD-Sequence
!theme aws-orange

title Processamento de V√≠deo - Fluxo Completo\n(EventBridge + API Destination + SQS + KEDA + SES)

skinparam backgroundColor #FEFEFE
skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 200

' Participantes organizados por camada
box "Cliente" #LightBlue
    actor Usuario as user
end box

box "Auth" #LightGreen
    participant "Cognito" as cognito
end box

box "FIAPX API (Elysia)" #LightYellow
    participant "POST /videos" as apiCreate
    participant "GET /upload-urls" as apiUrls
    participant "POST /parts/{n}" as apiParts
    participant "POST /complete" as apiComplete
    participant "POST /webhooks/s3" as apiWebhook
end box

box "AWS Storage" #Orange
    database "S3 Videos" as s3
    database "S3 Frames" as s3frames
end box

box "AWS Events" #Pink
    participant "EventBridge" as eb
    participant "API Dest\n(Webhook)" as apiDestHook
    participant "API Dest\n(SES)" as apiDestSES
    queue "SQS Split" as sqsSplit
    queue "SQS Print" as sqsPrint
end box

box "Kubernetes (Spot)" #Gray
    participant "KEDA Split" as kedaSplit
    participant "KEDA Print" as kedaPrint
    participant "FFmpeg Job" as ffmpeg
end box

box "Notifications (Zero Lambda)" #LightCyan
    participant "SES\nTemplates" as ses
end box

database "ScyllaDB" as db #Gold

== 0. Autentica√ß√£o ==

user -> cognito: POST /auth/login (email)
cognito --> user: C√≥digo OTP (email)
user -> cognito: POST /auth/verify (c√≥digo)
cognito --> user: JWT Token

== 1. Criar V√≠deo ==

user -> apiCreate: POST /videos\n{totalSize, duration}
activate apiCreate
apiCreate -> s3: CreateMultipartUpload
s3 --> apiCreate: uploadId
apiCreate -> db: INSERT video (CREATED)
apiCreate --> user: {videoId, uploadId, totalParts}
deactivate apiCreate

== 2. Obter URLs (Paginado - ADR 006) ==

loop Batch de 20 URLs
    user -> apiUrls: GET /upload-urls?start=N&limit=20
    activate apiUrls
    apiUrls -> s3: getSignedUrl (x20)
    apiUrls -> db: UPDATE status = UPLOADING
    apiUrls --> user: {urls: [...20], nextStart}
    deactivate apiUrls
end

== 3. Upload Paralelo (Presigned URLs) ==

user -> s3: PUT presigned URL (parte 1)
s3 --> user: ETag
user -> apiParts: POST /parts/1 {etag}
apiParts -> db: UPDATE part 1 (uploaded)

note over user, s3
    **Upload direto no S3** (Zero proxy no backend)
    Upload paralelo de at√© 20 partes simult√¢neas.
    Cliente reporta ETag de cada parte para tracking.
end note

== 4. Finalizar Upload ==

user -> apiComplete: POST /complete\n{parts: [{partNumber, etag}...]}
activate apiComplete
apiComplete -> s3: CompleteMultipartUpload
s3 --> apiComplete: 200 OK
apiComplete --> user: 202 Accepted
deactivate apiComplete

== 5. Evento S3 ‚Üí Webhook (ADR 010) ==

s3 -> eb: Object Created\n(CompleteMultipartUpload)
activate eb
eb -> apiDestHook: Roteia evento
apiDestHook -> apiWebhook: POST /webhooks/s3/complete
activate apiWebhook

note over apiWebhook
    **RECONCILIA√á√ÉO**
    Se chegou aqui, upload est√° 100% OK.
    Sistema marca todas as partes como UPLOADED
    mesmo que cliente n√£o tenha reportado.
end note

apiWebhook -> db: UPDATE status = UPLOADED\n(reconcilia partes)
apiWebhook -> eb: PutEvents\n(Video Status Changed: UPLOADED)
deactivate apiWebhook
eb -> sqsSplit: Enfileira mensagem
deactivate eb

== 6. Split do V√≠deo (KEDA + Spot) ==

sqsSplit -> kedaSplit: Poll (KEDA escala pod)
activate kedaSplit
kedaSplit -> ffmpeg: Cria K8s Job
activate ffmpeg
ffmpeg -> s3: Download v√≠deo
ffmpeg -> ffmpeg: FFmpeg split\n(segmentos 60s)
ffmpeg -> db: UPDATE status = SPLITTING
ffmpeg -> eb: PutEvents\n(Video Status Changed: SPLITTING)
deactivate ffmpeg
deactivate kedaSplit

== 6.1. Notifica√ß√£o "Quase L√°" (ADR 007) ==

eb -> apiDestSES: Roteia (status = SPLITTING)
apiDestSES -> ses: SendTemplatedEmail\n(VideoQuaseFinalizado)
ses --> user: Email: "Seu v√≠deo est√° quase pronto! üé¨"

== 7. Extra√ß√£o de Frames ==

eb -> sqsPrint: Enfileira segmentos
sqsPrint -> kedaPrint: Poll (KEDA escala pod)
activate kedaPrint
kedaPrint -> ffmpeg: Cria K8s Job
activate ffmpeg
ffmpeg -> s3: Download segmento
ffmpeg -> ffmpeg: FFmpeg extract\n(1 frame/segundo)
ffmpeg -> s3frames: Upload frames
ffmpeg -> db: UPDATE status = COMPLETED
ffmpeg -> eb: PutEvents\n(Video Status Changed: COMPLETED)
deactivate ffmpeg
deactivate kedaPrint

== 8. Notifica√ß√£o Final (ADR 007, 008) ==

eb -> apiDestSES: Roteia (status = COMPLETED)
apiDestSES -> ses: SendTemplatedEmail\n(VideoConcluido)
ses --> user: Email: "Seu v√≠deo est√° pronto! ‚úÖ"

== Fluxo Conclu√≠do ==

note over user, db
    **Tempo total estimado (1GB/1h):**
    - Upload 100 partes: ~2 min
    - Split (60 segmentos): ~30s
    - Print frames: ~3 min
    - **Total: ~5 minutos**

    **Economia vs Lambda: 99%**
    (KEDA + Spot Instances)
end note

@enduml
