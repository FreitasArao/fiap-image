@startuml Basic Sample
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

    System_Boundary(frontend, "Frontend", "Frontend system") {
        Person(userInitiate, "User", "Usuário inicia envio do vídeo")
        Person(userProcess, "User", "Usuário processa o vídeo")
    }

    System_Boundary(fiapx, "FIAPX", "FiapX system") {
        Container(createURL, "/create-url", "Cria uma URL para o vídeo para processar o video")
        Container(processVideo, "/{video_id}", "Processa o vídeo", "{chunk_number, etag}")
        Container(completeMultipartUpload, "/{video_id}", "Finaliza o upload de partes do vídeo")
    }

    System_Boundary(aws, "AWS", "AWS system") {
        Container(awsS3PreSignedURL, "AWS S3", "Serviço de armazenamento de objetos")
        Container(awsS3PartUpload, "AWS S3 Part Upload", "Upload de partes do vídeo")
        Container(awsS3CompleteMultipartUpload, "AWS S3 Complete Multipart Upload", "Evento de finalização do upload de partes do vídeo")
        Container(awsSQSSplitVideo, "AWS SQS Split Video", "Serviço de divisão do vídeo em partes por tempo do video")
        Container(awsSQSPrintVideo, "AWS SQS Print Video", "Publica a mensagem na fila de impressão do vídeo")
        Container(awsSQSDLQ, "AWS SQS DLQ", "Dead Letter Queue para mensagens com falha")
        Container(awsLambda, "AWS Lambda", "Serviço de função lambda")
        Container(awsLambdaCompleteMultipartUpload, "AWS Lambda Complete Multipart Upload", "Manipula o evento de finalização do upload de partes do vídeo")
    }

    System_Boundary(k8s, "Kubernetes", "Kubernetes system") {
        Container(k8sPodSplitVideo, "Kubernetes Pod Split Video", "Pod de divisão do vídeo em partes por tempo do video")
        Container(k8sPodPrintVideo, "Kubernetes Pod Print Video", "Pod de impressão do vídeo")
    }

    note right of k8s
    **Otimização de Custo: Spot Instances**
    - Usar Spot Instances
    - Redução de custo de compute
    end note


    System_Boundary(database, "Database", "Database system") {
        Container(cassandraDB, "Cassandra DB", "Serviço de banco de dados Cassandra")
    }

    Rel(userInitiate, createURL, "Cria urls pré-assinadas para o vídeo", "HTTP", "POST", "POST /create-url")
    Rel(createURL, cassandraDB, "Salva o video_id no Cassandra DB")

    note right of createURL
    - Calcula partSize e partsCount
    - CreateMultipartUpload (S3)
    - Gera presigned URLs para cada parte
    - Retorna videoId + uploadUrls (https://docs.aws.amazon.com/AmazonS3/latest/userguide/using-presigned-url.html)
    end note

    Rel(userProcess, awsS3PreSignedURL, "Realiza o upload do vídeo direto no S3", "HTTP", "POST", "pre-signed urls")
    Rel(awsS3PreSignedURL, awsS3PartUpload, "Cada url pré-assinada é usada para upload de uma parte do vídeo")
    Rel_L(awsS3PartUpload, awsLambda, "Chama a função lambda para multi-part uploaded")

    note right of awsLambda
    - Recebe: bucket, key, uploadId
    - Envia ETag + PartNumber para a lambda
    end note

    Rel(awsLambda, processVideo, "Retorna o chunk_number e o etag", "HTTP", "POST", "POST /process-video/{video_id}")
    Rel(processVideo, cassandraDB, "Salva o chunk_number e o etag no Cassandra DB para cada parte do vídeo")

    Rel(awsS3CompleteMultipartUpload, awsLambdaCompleteMultipartUpload, "S3 envia evento de finalização do upload de partes do vídeo para a lambda")
    Rel(awsLambdaCompleteMultipartUpload, completeMultipartUpload, "Lambda finaliza o upload de partes do vídeo")

    note top of completeMultipartUpload
    - Recebe: video_id
    - Finaliza o upload de partes do vídeo
    - Atualiza o status do vídeo para "completed"
    end note


    Rel(completeMultipartUpload, awsSQSSplitVideo, "Publica mensagem na fila de divisão do vídeo em partes por tempo do video", "{video_id}")
    Rel_Back(awsSQSSplitVideo, k8sPodSplitVideo, "Consome a mensagem da fila de divisão do vídeo em partes por tempo do video", "Divide por X minutos")
    Rel(k8sPodSplitVideo, awsSQSPrintVideo, "Publica a mensagem na fila de impressão do vídeo", "{etag, part_number}")
    Rel_Back(awsSQSPrintVideo, k8sPodPrintVideo, "Consome a mensagem da fila de impressão do vídeo")

    Rel(awsSQSSplitVideo, awsSQSDLQ, "Mensagens com falha após N tentativas")
    Rel(awsSQSPrintVideo, awsSQSDLQ, "Mensagens com falha após N tentativas")

    note left of awsSQSDLQ
    **Dead Letter Queue (DLQ)**
    - Captura mensagens que falharam após N tentativas
    - Evita loop infinito de mensagens com erro
    - Permite análise e reprocessamento manual
    - Configurar alarme para monitorar DLQ
    end note

    note bottom of k8sPodSplitVideo
    - Recebe: video_id
    - Divide o vídeo em partes por tempo do video(1 minuto)
    - Publica a mensagem na fila de impressão do vídeo para cada parte do vídeo
    end note

    note bottom of k8sPodPrintVideo
    - Recebe: etag, part_number
    - Tira print a cada 1 segundo ao longo do tempo definido no video(FFMPEG)
    end note
@enduml