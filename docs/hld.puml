@startuml Video-Processing-Full-Phases

!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
LAYOUT_TOP_DOWN()

title Video Processing - Fluxo Completo por Etapas

' =====================================================
' ETAPA 1 - LOGIN OTP (UNAUTH)
' =====================================================
Person(user1, "Usuário Deslogado")

System_Boundary(front1, "Frontend - Unauthenticated") {
  Container(login1, "Login OTP", "Web", "Solicita código por email")
}

System_Boundary(cognito1, "Amazon Cognito") {
  Container(pool1, "User Pool", "Auth", "Envia OTP + emite JWT")
}

Rel(user1, login1, "Solicita login")
Rel(login1, pool1, "InitiateAuth")
Rel(pool1, user1, "OTP + JWT")

' =====================================================
' ETAPA 2 - CRIAR VÍDEO (CREATED)
' =====================================================
Person(user2, "Usuário Logado")

System_Boundary(front2, "Frontend - Authenticated") {
  Container(dashboard2, "Dashboard", "Web", "Gerencia vídeos")
}

System_Ext(apiGw2, "AWS API Gateway", "JWT Authorizer")

System_Boundary(api2, "FIAPX API") {
  Container(create2, "POST /videos", "API", "Cria vídeo\nStatus=CREATED")
}

Rel(user2, dashboard2, "Acessa sistema")
Rel(dashboard2, apiGw2, "JWT")
Rel(apiGw2, create2, "Forward")
Rel(create2, dashboard2, "Video criado")

' =====================================================
' ETAPA 3 - GERAR URL DE UPLOAD (UPLOADING)
' =====================================================
System_Boundary(front3, "Frontend - Authenticated") {
  Container(upload3, "Upload UI", "Web", "Inicia upload")
}

System_Boundary(api3, "FIAPX API") {
  Container(url3, "POST /videos/{id}/upload-url", "API", "Status=UPLOADING")
}

System_Boundary(s3_3, "AWS S3") {
  Container(presign3, "Presigned URLs", "S3", "Multipart upload")
}

Rel(user2, upload3, "Seleciona vídeo")
Rel(upload3, apiGw2, "JWT")
Rel(apiGw2, url3, "Forward")
Rel(url3, presign3, "Gera URLs")

' =====================================================
' ETAPA 4 - UPLOAD COMPLETO (UPLOADED) - CORRIGIDA
' =====================================================
System_Boundary(s3_4, "AWS S3") {
  Container(multipart4, "Multipart Upload", "S3", "Upload completo")
}

System_Boundary(events4, "AWS EventBridge") {
  Container(rule4, "S3 Complete Rule", "Rule", "Detecta upload finalizado")
}

System_Boundary(api4, "FIAPX API") {
  Container(confirm4, "POST /videos/{id}/uploaded", "API", "Status=UPLOADED")
}

Rel(presign3, multipart4, "Upload das partes")
Rel(multipart4, rule4, "Evento CompleteMultipartUpload")
Rel(rule4, confirm4, "Notifica API")

' =====================================================
' ETAPA 5 - PROCESSAMENTO (PROCESSING)
' =====================================================
System_Boundary(events5, "AWS EventBridge") {
  Container(rule5, "Processing Rule", "Rule", "Dispara processamento")
}

System_Boundary(api5, "FIAPX API") {
  Container(process5, "POST /process-video/{id}", "API", "Status=PROCESSING")
}

Rel(confirm4, rule5, "Evento de vídeo UPLOADED")
Rel(rule5, process5, "Notifica API")

' =====================================================
' ETAPA 6 - SPLIT VIDEO (SPLITTED)
' =====================================================
System_Boundary(sqs6, "AWS SQS") {
  Container(splitQ6, "Split Queue", "SQS", "Fila de divisão")
}

System_Boundary(k8s6, "Kubernetes") {
  Container(worker6, "Split Worker", "Pod", "Consome SQS")
  Container(job6, "Split Job", "Job", "Divide vídeo\nStatus=SPLITTED")
}

Rel(process5, splitQ6, "Publica job")
Rel(splitQ6, worker6, "Consome")
Rel(worker6, job6, "Executa split")

' =====================================================
' ETAPA 7 - PRINT FRAMES (PRINTING)
' =====================================================
System_Boundary(sqs7, "AWS SQS") {
  Container(printQ7, "Print Queue", "SQS", "Fila de frames")
}

System_Boundary(k8s7, "Kubernetes") {
  Container(worker7, "Print Worker", "Pod", "Consome SQS")
  Container(job7, "Print Job", "Job", "Extrai frames\nStatus=PRINTING")
}

System_Boundary(s3_7, "AWS S3") {
  Container(images7, "Images Bucket", "S3", "Armazena prints")
}

Rel(job6, printQ7, "Publica partes")
Rel(printQ7, worker7, "Consome")
Rel(worker7, job7, "Processa frames")
Rel(job7, images7, "Salva imagens")

' =====================================================
' ETAPA 8 - FINALIZAÇÃO (COMPLETED)
' =====================================================
System_Boundary(events8, "AWS EventBridge") {
  Container(rule8, "PrintCompleted Rule", "Rule", "Detecta último frame")
}

System_Boundary(api8, "FIAPX API") {
  Container(done8, "POST /print-completed/{id}", "API", "Status=COMPLETED")
}

Rel(images7, rule8, "Evento S3")
Rel(rule8, done8, "Notifica API")

@enduml
