@startuml HLD-Architecture
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

LAYOUT_LEFT_RIGHT()
HIDE_STEREOTYPE()
title Processamento de Video - Pipeline Streaming com Fan-out

legend right
  |= Cor |= Tipo |
  | <#438DD5> | AWS Services |
  | <#1168BD> | API / Backend |
  | <#999999> | Kubernetes |
  | <#FF9900> | Banco de Dados |
endlegend

Person(userAuth, "Usuario", "Login")
Person(userUpload, "Usuario", "Upload do video")
Person(userNotify, "Usuario", "Recebe notificacao")

System_Boundary(block_auth, "BLOCO A - Autenticacao") {
  Container(cognito_A, "Cognito", "AWS", "Auth OTP")
}

Rel(userAuth, cognito_A, "0. Login OTP")
Rel(cognito_A, userAuth, "JWT")

System_Boundary(block_upload, "BLOCO B - Upload") {
  Container(apiVideos_B, "POST /videos", "Elysia", "Cria video")
  Container(apiUrls_B, "GET /upload-urls", "Elysia", "Batch 20 URLs")
  Container(apiParts_B, "POST /parts/{n}", "Elysia", "Reporta ETag")
  Container(apiComplete_B, "POST /complete", "Elysia", "Finaliza upload")

  ContainerDb(s3Upload_B, "S3 Videos (Upload)", "S3", "Multipart Upload")
  ContainerDb(cassandraUpload_B, "Casssandra", "CQL", "Status video")
}

Rel(userUpload, apiVideos_B, "1. Cria video")
Rel(apiVideos_B, s3Upload_B, "CreateMultipartUpload")
Rel(apiVideos_B, cassandraUpload_B, "CREATED")

Rel(userUpload, apiUrls_B, "2. Solicita URLs")
Rel(apiUrls_B, s3Upload_B, "getSignedUrl")
Rel(apiUrls_B, cassandraUpload_B, "UPLOADING")

Rel(userUpload, s3Upload_B, "3. Upload partes")
Rel(userUpload, apiParts_B, "4. Reporta ETag")
Rel(apiParts_B, cassandraUpload_B, "Atualiza parte")

Rel(userUpload, apiComplete_B, "5. Finaliza")
Rel(apiComplete_B, s3Upload_B, "CompleteMultipart")

System_Boundary(block_events, "BLOCO C - S3 -> EventBridge -> SQS") {
  Container(eventbridge_C, "EventBridge", "AWS", "Roteamento")
  ContainerQueue(sqsMultipart_C, "SQS Multipart", "SQS", "Eventos S3")
  Container(apiConsumer_C, "API Consumer", "Elysia", "Processa eventos S3")

  ContainerQueue(sqsOrch_C, "SQS Orchestrator", "SQS", "Fila orquestracao")
  ContainerQueue(sqsPrint_C, "SQS Print", "SQS", "Fila print (N msgs)")

  ContainerDb(cassandraEvent_C, "Casssandra", "CQL", "UPLOADED")
}

Rel(s3Upload_B, eventbridge_C, "6. Object Created")
Rel(eventbridge_C, sqsMultipart_C, "Enfileira")
Rel(sqsMultipart_C, apiConsumer_C, "Poll")
Rel(apiConsumer_C, cassandraEvent_C, "UPLOADED")
Rel(apiConsumer_C, eventbridge_C, "7. Status Changed")
Rel(eventbridge_C, sqsOrch_C, "Enfileira")

System_Boundary(block_orch, "BLOCO D - Orchestrator") {
  Container(kedaOrch_D, "Orchestrator Worker", "KEDA", "Consome SQS")
  Container(jobOrch_D, "Calcula Ranges", "Bun", "Fan-out N msgs")
}

Rel(sqsOrch_C, kedaOrch_D, "8. Poll")
Rel(kedaOrch_D, jobOrch_D, "Processa")
Rel(jobOrch_D, sqsPrint_C, "9. Publica N msgs")

System_Boundary(block_print, "BLOCO E - Print (Paralelo)") {
  Container(kedaPrint_E1, "Print Worker 1", "KEDA", "Seg 0-10s")
  Container(kedaPrint_E2, "Print Worker 2", "KEDA", "Seg 10-20s")
  Container(kedaPrint_EN, "Print Worker N", "KEDA", "Seg ...")

  ContainerDb(s3Frames_E, "S3 Frames", "S3", "Frames extraidos")
  ContainerDb(cassandraDone_E, "Casssandra", "CQL", "Progresso")
}

Rel(sqsPrint_C, kedaPrint_E1, "10. Poll")
Rel(sqsPrint_C, kedaPrint_E2, "10. Poll")
Rel(sqsPrint_C, kedaPrint_EN, "10. Poll")
Rel(kedaPrint_E1, s3Upload_B, "HTTP Range")
Rel(kedaPrint_E2, s3Upload_B, "HTTP Range")
Rel(kedaPrint_EN, s3Upload_B, "HTTP Range")
Rel(kedaPrint_E1, s3Frames_E, "Upload frames")
Rel(kedaPrint_E2, s3Frames_E, "Upload frames")
Rel(kedaPrint_EN, s3Frames_E, "Upload frames")
Rel(kedaPrint_EN, cassandraDone_E, "11. COMPLETED")
Rel(kedaPrint_EN, eventbridge_C, "Status Changed")

System_Boundary(block_notify, "BLOCO F - Notificacao") {
  Container(apiDestSES_F, "API Destination", "EB", "Notificacao SES")
  Container(ses_F, "SES", "AWS", "Email Templates")
}

Rel(eventbridge_C, apiDestSES_F, "Roteia")
Rel(apiDestSES_F, ses_F, "12. SendTemplatedEmail")
Rel_Back(ses_F, userNotify, "Email: Concluido / Falha")

@enduml
