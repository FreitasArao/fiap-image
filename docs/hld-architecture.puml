@startuml HLD-Flow-Blocks-UserPhases
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

LAYOUT_LEFT_RIGHT()
HIDE_STEREOTYPE()
title Processamento de Vídeo - Arquitetura Final\n(Usuário duplicado por fase)

legend right
  |= Cor |= Tipo |
  | <#438DD5> | AWS Services |
  | <#1168BD> | API / Backend |
  | <#999999> | Kubernetes |
  | <#FF9900> | Banco de Dados |
endlegend

' =========================
' USUÁRIOS POR FASE
' =========================
Person(userAuth, "Usuário", "Login")
Person(userUpload, "Usuário", "Upload do vídeo")
Person(userProcess, "Usuário", "Dispara processamento")
Person(userNotify, "Usuário", "Recebe notificação")

' =========================
' BLOCO A — AUTH
' =========================
System_Boundary(block_auth, "BLOCO A — Autenticação") {
  Container(cognito_A, "Cognito", "AWS", "Auth OTP")
}

Rel(userAuth, cognito_A, "0. Login OTP")
Rel(cognito_A, userAuth, "JWT")

' =========================
' BLOCO B — UPLOAD
' =========================
System_Boundary(block_upload, "BLOCO B — Upload") {
  Container(apiVideos_B, "POST /videos", "Elysia", "Cria vídeo")
  Container(apiUrls_B, "GET /upload-urls", "Elysia", "Batch 20 URLs")
  Container(apiParts_B, "POST /parts/{n}", "Elysia", "Reporta ETag")
  Container(apiComplete_B, "POST /complete", "Elysia", "Finaliza upload")

  ContainerDb(s3Upload_B, "S3 Videos (Upload)", "S3", "Multipart Upload")
  ContainerDb(cassandraUpload_B, "ScyllaDB", "CQL", "Status vídeo")
}

Rel(userUpload, apiVideos_B, "1. Cria vídeo")
Rel(apiVideos_B, s3Upload_B, "CreateMultipartUpload")
Rel(apiVideos_B, cassandraUpload_B, "CREATED")

Rel(userUpload, apiUrls_B, "2. Solicita URLs")
Rel(apiUrls_B, s3Upload_B, "getSignedUrl")
Rel(apiUrls_B, cassandraUpload_B, "UPLOADING")

Rel(userUpload, s3Upload_B, "3. Upload partes")
Rel(userUpload, apiParts_B, "4. Reporta ETag")
Rel(apiParts_B, cassandraUpload_B, "Atualiza parte")

Rel(userUpload, apiComplete_B, "5. Finaliza")
Rel(apiComplete_B, s3Upload_B, "CompleteMultipart")

' =========================
' BLOCO C — EVENTO S3
' =========================
System_Boundary(block_events, "BLOCO C — S3 → EventBridge") {
  Container(eventbridge_C, "EventBridge", "AWS", "Roteamento")
  Container(apiDestWebhook_C, "API Destination", "EB", "Webhook")
  Container(apiWebhook_C, "POST /webhooks/s3", "Elysia", "Recebe evento")

  ContainerQueue(sqsSplit_C, "SQS Split", "SQS", "Fila split")
  ContainerQueue(sqsPrint_C, "SQS Print", "SQS", "Fila print")

  ContainerDb(cassandraEvent_C, "ScyllaDB", "CQL", "UPLOADED")
}

Rel(s3Upload_B, eventbridge_C, "6. Object Created")
Rel(eventbridge_C, apiDestWebhook_C, "Roteia")
Rel(apiDestWebhook_C, apiWebhook_C, "POST webhook")
Rel(apiWebhook_C, cassandraEvent_C, "UPLOADED")
Rel(apiWebhook_C, eventbridge_C, "7. Status Changed")
Rel(eventbridge_C, sqsSplit_C, "Enfileira")
Rel(eventbridge_C, sqsPrint_C, "Enfileira")

' =========================
' BLOCO D — SPLIT
' =========================
System_Boundary(block_split, "BLOCO D — Split") {
  Container(kedaSplit_D, "Split Worker", "KEDA", "Consome SQS")
  Container(jobSplit_D, "FFmpeg Split", "Job", "Divide vídeo")

  ContainerDb(s3Split_D, "S3 Videos (Read)", "S3", "Download")
  ContainerDb(cassandraSplit_D, "ScyllaDB", "CQL", "SPLITTING")
}

Rel(sqsSplit_C, kedaSplit_D, "8. Poll")
Rel(kedaSplit_D, jobSplit_D, "Cria Job")
Rel(jobSplit_D, s3Split_D, "Download")
Rel(jobSplit_D, cassandraSplit_D, "SPLITTING")
Rel(jobSplit_D, eventbridge_C, "9. Status Changed")

' =========================
' BLOCO E — PRINT
' =========================
System_Boundary(block_print, "BLOCO E — Print") {
  Container(kedaPrint_E, "Print Worker", "KEDA", "Consome SQS")
  Container(jobPrint_E, "FFmpeg Print", "Job", "Extrai frames")

  ContainerDb(s3Frames_E, "S3 Frames", "S3", "Salva frames")
  ContainerDb(cassandraDone_E, "ScyllaDB", "CQL", "COMPLETED")
}

Rel(sqsPrint_C, kedaPrint_E, "10. Poll")
Rel(kedaPrint_E, jobPrint_E, "Cria Job")
Rel(jobPrint_E, s3Frames_E, "Salva frames")
Rel(jobPrint_E, cassandraDone_E, "COMPLETED")
Rel(jobPrint_E, eventbridge_C, "11. Status Changed")

' =========================
' BLOCO F — NOTIFICAÇÃO
' =========================
System_Boundary(block_notify, "BLOCO F — Notificação") {
  Container(apiDestSES_F, "API Destination", "EB", "Notificação SES")
  Container(ses_F, "SES", "AWS", "Email Templates")
}

Rel(eventbridge_C, apiDestSES_F, "Roteia")
Rel(apiDestSES_F, ses_F, "12. SendTemplatedEmail")
Rel_Back(ses_F, userNotify, "Email: Quase lá / Concluído / Falha")

@enduml
