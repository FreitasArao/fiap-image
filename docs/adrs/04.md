# ADR 004 — Alta Disponibilidade e Consistência Eventual não tem problema

| Campo      | Valor                |
|------------|----------------------|
| Status     | Aceito               |
| Data       | 2026-01-16           |
| Autor      | Arão Freitas         |


## Contexto

O sistema de processamento de vídeos é assíncrono: upload multipart (100 partes de 10MB), eventos via EventBridge, workers de split/print via SQS. O tempo total de processamento de um vídeo de 1GB/1hora é de aproximadamente 5 minutos. Bancos relacionais com garantias ACID introduzem overhead desnecessario

## Decisão

Adotar consistência eventual com Replication Factor 3, escrita QUORUM (2 de 3) e leitura ONE. A latência de convergência (milissegundos) é irrelevante para um processo que leva minutos.

## Consequências

### Positivas

- **Processamento assíncrono**: Usuário recebe 202 Accepted imediatamente, sem bloqueio
- **Operações idempotentes**: Cada operação pode ser reexecutada sem efeitos colaterais
- **Tolerância a falhas**: Retry automático do EventBridge/SQS resolve inconsistências temporárias
- **Alta disponibilidade**: Arquitetura masterless com 99.99% SLA, 2 nós podem falhar sem impacto
- **Recovery automático**: Nó que retorna sincroniza automaticamente com o cluster

#### Flexibilidade futura:

- Configuração de consistência por query permite ajustar trade-offs conforme necessidade

### Negativas

- Leituras podem retornar dados desatualizados por alguns milissegundos após escrita
- Debugging de inconsistências temporárias pode ser mais complexo

## Alternativas Consideradas

1. **Consistência forte (ALL/ALL)**: Descartado por latência elevada e indisponibilidade quando 1 nó falha
2. **Banco relacional com ACID**: Descartado por overhead desnecessário para processamento assíncrono e escalabilidade vertical limitada
3. **Leitura QUORUM**: Descartado por latência adicional sem benefício real para o caso de uso

## Referências

- [ScyllaDB Consistency Levels](https://docs.scylladb.com/stable/cql/consistency.html)
- [Apache Cassandra - Tunable Consistency](https://cassandra.apache.org/doc/latest/cassandra/architecture/dynamo.html#tunable-consistency)
- [CAP Theorem - Brewer's Conjecture](https://en.wikipedia.org/wiki/CAP_theorem)

