# ADR 007 â€” Monitoramento de Upload e Eventos via EventBridge + SQS

| Campo      | Valor                |
|------------|----------------------|
| Status     | Aceito               |
| Data       | 2026-01-17           |
| Autor      | ArÃ£o Freitas         |

## Contexto

O sistema precisa:

1. **Monitorar progresso de uploads multipart** em tempo real
2. **Detectar conclusÃ£o do upload** para disparar processamento
3. **Detectar uploads abandonados** ou com falha

### LimitaÃ§Ã£o do S3 EventBridge

**IMPORTANTE**: O S3 **NÃƒO emite eventos para cada parte individual** (`UploadPart`).

Eventos S3 disponÃ­veis via EventBridge:

| Evento S3 | EventBridge Detail Type | DisponÃ­vel? |
|-----------|------------------------|-------------|
| `UploadPart` | - | **NÃƒO** |
| `CompleteMultipartUpload` | Object Created | **SIM** |
| `AbortMultipartUpload` | - | **NÃƒO** (apenas via API) |
| `PutObject` | Object Created | SIM |

Fonte: [S3 Event Notifications to EventBridge](https://docs.aws.amazon.com/AmazonS3/latest/userguide/EventBridge.html)

## DecisÃ£o

### 1. Monitoramento de Progresso: **Cliente Reporta**

Como o S3 nÃ£o emite eventos por parte, o **cliente deve reportar** o progresso apÃ³s cada upload bem-sucedido:

```
Cliente                           API                         S3
   â”‚                               â”‚                           â”‚
   â”‚â”€â”€ GET /upload-urls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                           â”‚
   â”‚â—„â”€ {urls: [20], etags: []} â”€â”€â”€â”€â”‚                           â”‚
   â”‚                               â”‚                           â”‚
   â”‚â”€â”€ PUT presigned URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ETag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                               â”‚                           â”‚
   â”‚â”€â”€ POST /parts/{partNumber} â”€â”€â–ºâ”‚ (reporta ETag)            â”‚
   â”‚   {etag: "abc123"}            â”‚                           â”‚
   â”‚â—„â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                           â”‚
   â”‚                               â”‚                           â”‚
   â”‚   (repete para cada parte)    â”‚                           â”‚
   â”‚                               â”‚                           â”‚
   â”‚â”€â”€ POST /complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                           â”‚
   â”‚   {parts: [{part, etag}...]}  â”‚â”€â”€ CompleteMultipart â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚â—„â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€â”€â”€â”€ Object Created â”€â”€â”€â”€â”€â”‚
```

### 2. DetecÃ§Ã£o de ConclusÃ£o: **EventBridge**

Usar EventBridge apenas para detectar `CompleteMultipartUpload`:

```
S3 (CompleteMultipartUpload)
    â†“
EventBridge (Object Created, reason: CompleteMultipartUpload)
    â””â”€â†’ SQS Queue â†’ KEDA Worker (processamento)
```

### 3. Arquitetura Final

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MONITORAMENTO DE UPLOAD                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Cliente â”€â”€â–º S3 (PUT parte) â”€â”€â–º Cliente recebe ETag             â”‚
â”‚                                       â”‚                          â”‚
â”‚                                       â–¼                          â”‚
â”‚                              API (POST /parts/{n})               â”‚
â”‚                                       â”‚                          â”‚
â”‚                                       â–¼                          â”‚
â”‚                                  Cassandra                       â”‚
â”‚                            (atualiza progresso)                  â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    DETECÃ‡ÃƒO DE CONCLUSÃƒO                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Cliente â”€â”€â–º API (POST /complete) â”€â”€â–º S3 (CompleteMultipart)    â”‚
â”‚                                              â”‚                   â”‚
â”‚                                              â–¼                   â”‚
â”‚                                        EventBridge               â”‚
â”‚                                              â”‚                   â”‚
â”‚                                              â–¼                   â”‚
â”‚                                         SQS Queue                â”‚
â”‚                                              â”‚                   â”‚
â”‚                                              â–¼                   â”‚
â”‚                                        KEDA Worker               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Endpoints NecessÃ¡rios

| Endpoint | MÃ©todo | DescriÃ§Ã£o |
|----------|--------|-----------|
| `/videos` | POST | Cria vÃ­deo, retorna uploadId |
| `/videos/{id}/upload-urls` | GET | Retorna batch de 20 URLs |
| `/videos/{id}/parts/{partNumber}` | POST | **Reporta ETag apÃ³s upload** |
| `/videos/{id}/progress` | GET | Consulta progresso atual |
| `/videos/{id}/complete` | POST | Finaliza multipart upload |

### Payload: Reportar Parte

```json
POST /videos/{id}/parts/1
{
  "etag": "\"d41d8cd98f00b204e9800998ecf8427e\""
}
```

### Payload: Consultar Progresso

```json
GET /videos/{id}/progress

Response:
{
  "videoId": "uuid",
  "status": "UPLOADING",
  "totalParts": 100,
  "uploadedParts": 45,
  "percentage": 45,
  "parts": [
    {"partNumber": 1, "etag": "abc", "uploadedAt": "2026-01-17T10:00:00Z"},
    {"partNumber": 2, "etag": "def", "uploadedAt": "2026-01-17T10:00:01Z"}
  ]
}
```

## Regra EventBridge

```json
{
  "source": ["aws.s3"],
  "detail-type": ["Object Created"],
  "detail": {
    "bucket": { "name": ["fiapx-videos"] },
    "reason": ["CompleteMultipartUpload"]
  }
}
```

## ReconciliaÃ§Ã£o: CompleteMultipartUpload como Fonte de Verdade

**Ponto crÃ­tico**: Se o S3 emite o evento `CompleteMultipartUpload`, significa que **todas as partes foram enviadas com sucesso**. O S3 sÃ³ aceita completar o upload se todas as partes estiverem presentes.

### CenÃ¡rio de Falha do Cliente

```
Cliente                           S3                          API
   â”‚                               â”‚                           â”‚
   â”‚â”€â”€ PUT parte 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                           â”‚
   â”‚â”€â”€ PUT parte 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                           â”‚
   â”‚â”€â”€ ...                         â”‚                           â”‚
   â”‚â”€â”€ PUT parte 100 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                           â”‚
   â”‚                               â”‚                           â”‚
   â”‚â”€â”€ CompleteMultipartUpload â”€â”€â”€â–ºâ”‚                           â”‚
   â”‚                               â”‚                           â”‚
   â”‚   âŒ Cliente crashou antes    â”‚                           â”‚
   â”‚   de chamar POST /complete    â”‚                           â”‚
   â”‚                               â”‚                           â”‚
   â”‚                               â”‚â”€â”€ Object Created â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                               â”‚   (EventBridge)           â”‚
   â”‚                               â”‚                           â”‚
   â”‚                               â”‚   âœ… API atualiza TODAS   â”‚
   â”‚                               â”‚   as partes + vÃ­deo       â”‚
   â”‚                               â”‚   para UPLOADED           â”‚
```

### LÃ³gica de ReconciliaÃ§Ã£o

Quando o evento `CompleteMultipartUpload` chega via EventBridge:

1. **Buscar vÃ­deo** pelo `object.key` (videoId)
2. **Se status < UPLOADED**:
   - Atualizar **todas as partes** que faltam para `status: UPLOADED`
   - Atualizar **vÃ­deo** para `status: UPLOADED`
3. **Publicar na SQS Split** para iniciar processamento

```typescript
// Pseudo-cÃ³digo do handler
async function handleCompleteMultipartUpload(event: S3Event) {
  const videoId = extractVideoId(event.detail.object.key);
  const video = await videoRepository.findById(videoId);

  if (video.status !== 'UPLOADED') {
    // Reconcilia: marca todas as partes como concluÃ­das
    await videoRepository.markAllPartsAsUploaded(videoId);
    await videoRepository.updateStatus(videoId, 'UPLOADED');
  }

  // Publica para processamento
  await sqsClient.sendMessage({
    queueUrl: SPLIT_QUEUE_URL,
    body: JSON.stringify({ videoId })
  });
}
```

### Por que isso Ã© importante?

| CenÃ¡rio | Sem ReconciliaÃ§Ã£o | Com ReconciliaÃ§Ã£o |
|---------|-------------------|-------------------|
| Cliente nÃ£o reportou partes | VÃ­deo fica UPLOADING para sempre | VÃ­deo vai para UPLOADED |
| Cliente crashou | Processamento nÃ£o inicia | Processamento inicia normalmente |
| Rede instÃ¡vel | Partes ficam pendentes | Partes marcadas como OK |
| App fechou antes de /complete | Dados inconsistentes | Dados consistentes |

### Garantia do S3

O `CompleteMultipartUpload` sÃ³ retorna sucesso se:
- Todas as partes especificadas existem no S3
- Os ETags de todas as partes conferem
- O objeto final foi criado com sucesso

**Se o evento chegou, o upload estÃ¡ 100% completo no S3.**

## ConsequÃªncias

### Positivas

- **Arquitetura correta**: NÃ£o depende de eventos inexistentes
- **Progresso real-time**: Cliente reporta imediatamente apÃ³s cada parte
- **ETags coletados**: NecessÃ¡rios para CompleteMultipartUpload
- **Desacoplamento**: EventBridge dispara processamento sem polling
- **ResiliÃªncia**: SQS com retry e DLQ

### Negativas

- Cliente precisa fazer 1 request adicional por parte (POST /parts/{n})
- Overhead de ~100 requests extras para vÃ­deo de 100 partes
- Se cliente nÃ£o reportar, progresso fica desatualizado, ate que receba o evento `CompleteMultipartUpload`

## Fluxo de Status

```
CREATED â†’ UPLOADING â†’ UPLOADED â†’ PROCESSING â†’ SPLITTING â†’ PRINTING â†’ COMPLETED
              â”‚           â”‚           â”‚            â”‚           â”‚          â”‚
              â–¼           â–¼           â–¼            â–¼           â–¼          â–¼
           (cliente   (EventBridge) (SQS)      (Job)       (Job)     (Email
            reporta)                                      + Email    final)
                                                         "quase lÃ¡"
```

### TransiÃ§Ãµes de Status

| Trigger | Status Anterior | Status Novo | NotificaÃ§Ã£o |
|---------|-----------------|-------------|-------------|
| POST /videos | - | CREATED | - |
| GET /upload-urls (primeira vez) | CREATED | UPLOADING | - |
| POST /parts/{n} | UPLOADING | UPLOADING | - |
| POST /complete | UPLOADING | UPLOADED | - |
| EventBridge â†’ SQS | UPLOADED | PROCESSING | - |
| Split Job concluÃ­do | PROCESSING | SPLITTING | **Email: "Quase lÃ¡"** |
| Print Job concluÃ­do | SPLITTING | COMPLETED | **Email: "ConcluÃ­do"** |
| Timeout/Erro | * | FAILED | **Email: "Falha"** |

## NotificaÃ§Ãµes por Email (SES Templates)

O sistema envia notificaÃ§Ãµes em momentos-chave usando **SES Templates** via **EventBridge API Destination** (sem Lambda).

### Templates SES

#### Template: VideoQuaseFinalizado
```html
OlÃ¡ {{name}},

Seu vÃ­deo "{{videoName}}" estÃ¡ quase pronto! ğŸ¬

Estamos finalizando o processamento e vocÃª receberÃ¡ outro email
quando estiver disponÃ­vel para download.

Status atual: Gerando imagens
Progresso: ~80%

Atenciosamente,
Equipe FIAPX
```

#### Template: VideoConcluido
```html
OlÃ¡ {{name}},

Seu vÃ­deo "{{videoName}}" foi processado com sucesso! âœ…

Clique no link abaixo para fazer o download:
{{downloadUrl}}

O link expira em 7 dias.

Atenciosamente,
Equipe FIAPX
```

#### Template: VideoFalhou
```html
OlÃ¡ {{name}},

Infelizmente houve um problema ao processar seu vÃ­deo "{{videoName}}". âŒ

Motivo: {{errorReason}}

Por favor, tente enviar novamente ou entre em contato com nosso suporte.

Atenciosamente,
Equipe FIAPX
```

### Arquitetura de NotificaÃ§Ãµes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NOTIFICAÃ‡Ã•ES VIA SES                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Split Job â”€â”€â–º EventBridge â”€â”€â–º API Destination â”€â”€â–º SES          â”‚
â”‚  (SPLITTING)      â”‚               â”‚                 â”‚            â”‚
â”‚                   â”‚               â”‚                 â–¼            â”‚
â”‚                   â”‚               â”‚          Template:           â”‚
â”‚                   â”‚               â”‚       "VideoQuaseFinalizado" â”‚
â”‚                   â”‚               â”‚                              â”‚
â”‚  Print Job â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚                              â”‚
â”‚  (COMPLETED)      â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º SES         â”‚
â”‚                   â”‚                                  â”‚            â”‚
â”‚                   â”‚                                  â–¼            â”‚
â”‚                   â”‚                           Template:           â”‚
â”‚                   â”‚                        "VideoConcluido"       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Regra EventBridge para NotificaÃ§Ãµes

```json
{
  "source": ["fiapx.video"],
  "detail-type": ["Video Status Changed"],
  "detail": {
    "status": ["SPLITTING", "COMPLETED", "FAILED"]
  }
}
```

### API Destination (SES)

```json
{
  "Name": "ses-notification",
  "Endpoint": "https://email.us-east-1.amazonaws.com/v2/email/outbound-emails",
  "HttpMethod": "POST",
  "InputTransformer": {
    "InputPathsMap": {
      "email": "$.detail.userEmail",
      "name": "$.detail.userName",
      "videoName": "$.detail.videoName",
      "status": "$.detail.status",
      "downloadUrl": "$.detail.downloadUrl"
    },
    "InputTemplate": "{\"Content\":{\"Template\":{\"TemplateName\":\"<status>\",\"TemplateData\":\"{\\\"name\\\":\\\"<name>\\\",\\\"videoName\\\":\\\"<videoName>\\\",\\\"downloadUrl\\\":\\\"<downloadUrl>\\\"}\"}}}"
  }
}
```

## Custos (10.000 vÃ­deos/mÃªs)

| Componente | Uso | Custo |
|------------|-----|-------|
| EventBridge (Object Created) | 10k eventos | $0.01 |
| EventBridge (Status Changed) | 30k eventos | $0.03 |
| SQS (Split Queue) | 10k mensagens | $0.004 |
| SQS (Print Queue) | 100k mensagens | $0.04 |
| SES (emails) | 30k emails | $0.30 |
| API Destination | 30k invocaÃ§Ãµes | GrÃ¡tis |
| API Requests (partes) | 1M requests | Incluso na API |
| **Total** | - | **~$0.38** |

## Alternativas Consideradas

1. **Polling S3 ListParts**: Descartado por custo alto ($0.005/1000 requests) e latÃªncia
2. **S3 Event para cada parte**: **NÃ£o existe** - S3 nÃ£o emite eventos para UploadPart
3. **WebSocket para progresso**: Descartado por complexidade sem benefÃ­cio claro
4. **Lambda intermediÃ¡rio**: Descartado por cold start e custo (ADR 002)

## ReferÃªncias

- [S3 Event Notifications to EventBridge](https://docs.aws.amazon.com/AmazonS3/latest/userguide/EventBridge.html)
- [EventBridge S3 Event Mapping](https://docs.aws.amazon.com/AmazonS3/latest/userguide/ev-mapping-troubleshooting.html)
- [S3 Multipart Upload](https://docs.aws.amazon.com/AmazonS3/latest/userguide/mpuoverview.html)
- [CompleteMultipartUpload API](https://docs.aws.amazon.com/AmazonS3/latest/API/API_CompleteMultipartUpload.html)
- [Amazon SQS Pricing](https://aws.amazon.com/sqs/pricing/)
- [Amazon EventBridge Pricing](https://aws.amazon.com/eventbridge/pricing/)
