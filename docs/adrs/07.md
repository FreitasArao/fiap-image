# ADR 007 ‚Äî Monitoramento de Upload e Eventos via EventBridge + SQS

| Campo      | Valor                |
|------------|----------------------|
| Status     | Aceito               |
| Data       | 2026-01-17           |
| Autor      | Ar√£o Freitas         |

## Contexto

O sistema precisa:

1. **Monitorar progresso de uploads multipart** em tempo real
2. **Detectar conclus√£o do upload** para disparar processamento
3. **Detectar uploads abandonados** ou com falha

### Limita√ß√£o do S3 EventBridge

**IMPORTANTE**: O S3 **N√ÉO emite eventos para cada parte individual** (`UploadPart`).

Eventos S3 dispon√≠veis via EventBridge:

| Evento S3 | EventBridge Detail Type | Dispon√≠vel? |
|-----------|------------------------|-------------|
| `UploadPart` | - | **N√ÉO** |
| `CompleteMultipartUpload` | Object Created | **SIM** |
| `AbortMultipartUpload` | - | **N√ÉO** (apenas via API) |
| `PutObject` | Object Created | SIM |

Fonte: [S3 Event Notifications to EventBridge](https://docs.aws.amazon.com/AmazonS3/latest/userguide/EventBridge.html)

## Decis√£o

### 1. Monitoramento de Progresso: **Cliente Reporta**

Como o S3 n√£o emite eventos por parte, o **cliente deve reportar** o progresso ap√≥s cada upload bem-sucedido:

```mermaid
sequenceDiagram
    participant Cliente
    participant API
    participant S3

    Cliente->>API: GET /upload-urls
    API-->>Cliente: {urls: [20], etags: []}

    loop Para cada parte
        Cliente->>S3: PUT presigned URL
        S3-->>Cliente: ETag
        Cliente->>API: POST /parts/{partNumber} {etag}
        API-->>Cliente: 200 OK
    end

    Cliente->>API: POST /complete {parts: [{part, etag}...]}
    API->>S3: CompleteMultipartUpload
    S3-->>API: Object Created
    API-->>Cliente: 200 OK
```

### 2. Detec√ß√£o de Conclus√£o: **EventBridge**

Usar EventBridge apenas para detectar `CompleteMultipartUpload`:

```mermaid
flowchart LR
    S3[S3 CompleteMultipartUpload] --> EB[EventBridge]
    EB -->|Object Created| SQS[SQS Queue]
    SQS --> KEDA[KEDA Worker]
```

### 3. Arquitetura Final

```mermaid
flowchart TB
    subgraph Monitoramento["MONITORAMENTO DE UPLOAD"]
        Cliente1[Cliente] -->|PUT parte| S3_1[S3]
        S3_1 -->|ETag| Cliente1
        Cliente1 -->|POST /parts/n| API1[API]
        API1 --> Cassandra[(Cassandra)]
    end

    subgraph Conclusao["DETEC√á√ÉO DE CONCLUS√ÉO"]
        Cliente2[Cliente] -->|POST /complete| API2[API]
        API2 -->|CompleteMultipart| S3_2[S3]
        S3_2 -->|Object Created| EventBridge[EventBridge]
        EventBridge --> SQS[SQS Queue]
        SQS --> KEDA[KEDA Worker]
    end
```

## Endpoints Necess√°rios

| Endpoint | M√©todo | Descri√ß√£o |
|----------|--------|-----------|
| `/videos` | POST | Cria v√≠deo, retorna uploadId |
| `/videos/{id}/upload-urls` | GET | Retorna batch de 20 URLs |
| `/videos/{id}/parts/{partNumber}` | POST | **Reporta ETag ap√≥s upload** |
| `/videos/{id}/progress` | GET | Consulta progresso atual |
| `/videos/{id}/complete` | POST | Finaliza multipart upload |

### Payload: Reportar Parte

```json
POST /videos/{id}/parts/1
{
  "etag": "\"d41d8cd98f00b204e9800998ecf8427e\""
}
```

### Payload: Consultar Progresso

```json
GET /videos/{id}/progress

Response:
{
  "videoId": "uuid",
  "status": "UPLOADING",
  "totalParts": 100,
  "uploadedParts": 45,
  "percentage": 45,
  "parts": [
    {"partNumber": 1, "etag": "abc", "uploadedAt": "2026-01-17T10:00:00Z"},
    {"partNumber": 2, "etag": "def", "uploadedAt": "2026-01-17T10:00:01Z"}
  ]
}
```

## Regra EventBridge

```json
{
  "source": ["aws.s3"],
  "detail-type": ["Object Created"],
  "detail": {
    "bucket": { "name": ["fiapx-videos"] },
    "reason": ["CompleteMultipartUpload"]
  }
}
```

## Reconcilia√ß√£o: CompleteMultipartUpload como Fonte de Verdade

**Ponto cr√≠tico**: Se o S3 emite o evento `CompleteMultipartUpload`, significa que **todas as partes foram enviadas com sucesso**. O S3 s√≥ aceita completar o upload se todas as partes estiverem presentes.

### Cen√°rio de Falha do Cliente

```mermaid
sequenceDiagram
    participant Cliente
    participant S3
    participant API

    Cliente->>S3: PUT parte 1
    Cliente->>S3: PUT parte 2
    Note over Cliente,S3: ... (todas as partes)
    Cliente->>S3: PUT parte 100

    Cliente->>S3: CompleteMultipartUpload

    Note over Cliente: ‚ùå Cliente crashou antes<br/>de chamar POST /complete

    S3->>API: Object Created (EventBridge)

    Note over API: ‚úÖ API atualiza TODAS<br/>as partes + v√≠deo<br/>para UPLOADED
```

### L√≥gica de Reconcilia√ß√£o

Quando o evento `CompleteMultipartUpload` chega via EventBridge:

1. **Buscar v√≠deo** pelo `object.key` (videoId)
2. **Se status < UPLOADED**:
   - Atualizar **todas as partes** que faltam para `status: UPLOADED`
   - Atualizar **v√≠deo** para `status: UPLOADED`
3. **Publicar na SQS Split** para iniciar processamento

### Por que isso √© importante?

| Cen√°rio | Sem Reconcilia√ß√£o | Com Reconcilia√ß√£o |
|---------|-------------------|-------------------|
| Cliente n√£o reportou partes | V√≠deo fica UPLOADING para sempre | V√≠deo vai para UPLOADED |
| Cliente crashou | Processamento n√£o inicia | Processamento inicia normalmente |
| Rede inst√°vel | Partes ficam pendentes | Partes marcadas como OK |
| App fechou antes de /complete | Dados inconsistentes | Dados consistentes |

### Garantia do S3

O `CompleteMultipartUpload` s√≥ retorna sucesso se:
- Todas as partes especificadas existem no S3
- Os ETags de todas as partes conferem
- O objeto final foi criado com sucesso

**Se o evento chegou, o upload est√° 100% completo no S3.**

## Consequ√™ncias

### Positivas

- **Arquitetura correta**: N√£o depende de eventos inexistentes
- **Progresso real-time**: Cliente reporta imediatamente ap√≥s cada parte
- **ETags coletados**: Necess√°rios para CompleteMultipartUpload
- **Desacoplamento**: EventBridge dispara processamento sem polling
- **Resili√™ncia**: SQS com retry e DLQ

### Negativas

- Cliente precisa fazer 1 request adicional por parte (POST /parts/{n})
- Overhead de ~100 requests extras para v√≠deo de 100 partes
- Se cliente n√£o reportar, progresso fica desatualizado, ate que receba o evento `CompleteMultipartUpload`

## Fluxo de Status

```mermaid
flowchart LR
    CREATED --> UPLOADING
    UPLOADING --> UPLOADED
    UPLOADED --> PROCESSING
    PROCESSING --> SPLITTING
    SPLITTING --> PRINTING
    PRINTING --> COMPLETED

    UPLOADING -.->|cliente reporta| U1[ ]
    UPLOADED -.->|EventBridge| U2[ ]
    PROCESSING -.->|SQS| U3[ ]
    SPLITTING -.->|Job + Email 'quase l√°'| U4[ ]
    PRINTING -.->|Job| U5[ ]
    COMPLETED -.->|Email final| U6[ ]

    style U1 fill:none,stroke:none
    style U2 fill:none,stroke:none
    style U3 fill:none,stroke:none
    style U4 fill:none,stroke:none
    style U5 fill:none,stroke:none
    style U6 fill:none,stroke:none
```

### Transi√ß√µes de Status

| Trigger | Status Anterior | Status Novo | Notifica√ß√£o |
|---------|-----------------|-------------|-------------|
| POST /videos | - | CREATED | - |
| GET /upload-urls (primeira vez) | CREATED | UPLOADING | - |
| POST /parts/{n} | UPLOADING | UPLOADING | - |
| POST /complete | UPLOADING | UPLOADED | - |
| EventBridge ‚Üí SQS | UPLOADED | PROCESSING | - |
| Split Job conclu√≠do | PROCESSING | SPLITTING | **Email: "Quase l√°"** |
| Print Job conclu√≠do | SPLITTING | COMPLETED | **Email: "Conclu√≠do"** |
| Timeout/Erro | * | FAILED | **Email: "Falha"** |

## Notifica√ß√µes por Email (SES Templates)

O sistema envia notifica√ß√µes em momentos-chave usando **SES Templates** via **EventBridge API Destination** (sem Lambda).

### Templates SES

#### Template: VideoQuaseFinalizado
```html
Ol√° {{email}},

Seu v√≠deo "{{videoName}}" est√° quase pronto! üé¨

Estamos finalizando o processamento e voc√™ receber√° outro email
quando estiver dispon√≠vel para download.

Status atual: Gerando imagens
Progresso: ~80%

Atenciosamente,
Equipe FIAPX
```

#### Template: VideoConcluido
```html
Ol√° {{email}},

Seu v√≠deo "{{videoName}}" foi processado com sucesso! ‚úÖ

Clique no link abaixo para fazer o download:
{{downloadUrl}}

O link expira em 7 dias.

Atenciosamente,
Equipe FIAPX
```

#### Template: VideoFalhou
```html
Ol√° {{name}},

Infelizmente houve um problema ao processar seu v√≠deo "{{videoName}}". ‚ùå

Motivo: {{errorReason}}

Por favor, tente enviar novamente ou entre em contato com nosso suporte.

Atenciosamente,
Equipe FIAPX
```

### Arquitetura de Notifica√ß√µes

```mermaid
flowchart LR
    subgraph Jobs
        Split[Split Job<br/>SPLITTING]
        Print[Print Job<br/>COMPLETED]
    end

    subgraph AWS
        EB[EventBridge]
        API[API Destination]
        SES[SES]
    end

    subgraph Templates
        T1[VideoQuaseFinalizado]
        T2[VideoConcluido]
    end

    Split --> EB
    Print --> EB
    EB --> API
    API --> SES
    SES --> T1
    SES --> T2
```

### Regra EventBridge para Notifica√ß√µes

```json
{
  "source": ["fiapx.video"],
  "detail-type": ["Video Status Changed"],
  "detail": {
    "status": ["SPLITTING", "COMPLETED", "FAILED"]
  }
}
```

### API Destination (SES)

```json
{
  "Name": "ses-notification",
  "Endpoint": "https://email.us-east-1.amazonaws.com/v2/email/outbound-emails",
  "HttpMethod": "POST",
  "InputTransformer": {
    "InputPathsMap": {
      "email": "$.detail.userEmail",
      "name": "$.detail.userName",
      "videoName": "$.detail.videoName",
      "status": "$.detail.status",
      "downloadUrl": "$.detail.downloadUrl"
    },
    "InputTemplate": "{\"Content\":{\"Template\":{\"TemplateName\":\"<status>\",\"TemplateData\":\"{\\\"name\\\":\\\"<name>\\\",\\\"videoName\\\":\\\"<videoName>\\\",\\\"downloadUrl\\\":\\\"<downloadUrl>\\\"}\"}}}"
  }
}
```

## Custos (10.000 v√≠deos/m√™s)

| Componente | Uso | Custo |
|------------|-----|-------|
| EventBridge (Object Created) | 10k eventos | $0.01 |
| EventBridge (Status Changed) | 30k eventos | $0.03 |
| SQS (Split Queue) | 10k mensagens | $0.004 |
| SQS (Print Queue) | 100k mensagens | $0.04 |
| SES (emails) | 30k emails | $0.30 |
| API Destination | 30k invoca√ß√µes | Gr√°tis |
| API Requests (partes) | 1M requests | Incluso na API |
| **Total** | - | **~$0.38** |

## Alternativas Consideradas

1. **Polling S3 ListParts**: Descartado por custo alto ($0.005/1000 requests) e lat√™ncia
2. **S3 Event para cada parte**: **N√£o existe** - S3 n√£o emite eventos para UploadPart
3. **WebSocket para progresso**: Descartado por complexidade sem benef√≠cio claro
4. **Lambda intermedi√°rio**: Descartado por cold start e custo (ADR 002)

## Refer√™ncias

- [S3 Event Notifications to EventBridge](https://docs.aws.amazon.com/AmazonS3/latest/userguide/EventBridge.html)
- [EventBridge S3 Event Mapping](https://docs.aws.amazon.com/AmazonS3/latest/userguide/ev-mapping-troubleshooting.html)
- [S3 Multipart Upload](https://docs.aws.amazon.com/AmazonS3/latest/userguide/mpuoverview.html)
- [CompleteMultipartUpload API](https://docs.aws.amazon.com/AmazonS3/latest/API/API_CompleteMultipartUpload.html)
- [Amazon SQS Pricing](https://aws.amazon.com/sqs/pricing/)
- [Amazon EventBridge Pricing](https://aws.amazon.com/eventbridge/pricing/)
