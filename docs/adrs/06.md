# ADR 006 — Geração Progressiva de URLs Pré-assinadas (Paginação)

| Campo      | Valor                |
|------------|----------------------|
| Status     | Aceito               |
| Data       | 2026-01-17           |
| Autor      | Arão Freitas         |

## Contexto

O sistema atual gera todas as URLs pré-assinadas de uma vez ao criar um vídeo. Para um vídeo de 1GB dividido em 100 partes (10MB cada), isso significa gerar 100 URLs simultaneamente. Para arquivos maiores (até 50GB com 10.000 partes), isso causa:

- Tempo de resposta alto na criação inicial (~2-5s)
- URLs podem expirar antes do uso (expiração de 15min, upload pode levar 30min+)
- Overhead de memória no servidor e cliente
- Risco de timeout em conexões instáveis

## Decisão

Implementar geração progressiva de URLs em batches de 20, sob demanda do cliente.

### Novo Fluxo

```
1. POST /videos → Cria vídeo, retorna {videoId, uploadId, totalParts}
2. GET /videos/{id}/upload-urls?start=1&limit=20 → Retorna batch de URLs
3. Cliente faz upload das 20 partes
4. Repete passo 2-3 até completar todas as partes
5. POST /videos/{id}/complete → Finaliza multipart upload
```

### Configuração

| Parâmetro | Valor | Justificativa |
|-----------|-------|---------------|
| Batch Size | 20 URLs | Equilíbrio entre latência e overhead de requests |
| URL Expiration | 15 min | Tempo suficiente para upload + retry de 20 partes |
| Max Parts | 10.000 | Limite S3 para multipart upload |

## Consequências

### Positivas

- **Latência inicial reduzida**: Resposta em ~100ms vs ~2-5s
- **URLs sempre válidas**: Geradas sob demanda, nunca expiram antes do uso
- **Menor uso de memória**: 20 URLs vs 10.000 em memória
- **Resiliência**: Cliente pode pausar/retomar upload
- **Compatibilidade**: Mantém suporte a uploads pequenos (< 20 partes) sem mudanças

### Negativas

- Mais requests ao backend (N/20 requests vs 1)
- Cliente precisa implementar loop de paginação
- Complexidade adicional no frontend

## Cálculo de Overhead

| Cenário | Requests Antigo | Requests Novo | Overhead |
|---------|-----------------|---------------|----------|
| 100 partes (1GB) | 1 | 5 | +4 requests |
| 500 partes (5GB) | 1 | 25 | +24 requests |
| 10.000 partes (100GB) | 1 | 500 | +499 requests |

O overhead adicional é insignificante comparado ao tempo de upload (segundos vs minutos/horas).

## Alternativas Consideradas

1. **Gerar todas as URLs com expiração longa (1h+)**: Descartado por risco de segurança (URLs válidas por muito tempo)
2. **WebSocket para entrega de URLs**: Descartado por complexidade adicional sem benefício claro
3. **URLs sem expiração**: Descartado por ser anti-pattern de segurança

## Referências

- [S3 Presigned URLs](https://docs.aws.amazon.com/AmazonS3/latest/userguide/using-presigned-url.html)
- [S3 Multipart Upload Limits](https://docs.aws.amazon.com/AmazonS3/latest/userguide/qfacts.html)
- [AWS SDK Presigned URL Best Practices](https://docs.aws.amazon.com/AmazonS3/latest/userguide/PresignedUrlUploadObject.html)
