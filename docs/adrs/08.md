# ADR 008 ‚Äî Arquitetura H√≠brida: KEDA Workers + Lambda

| Campo      | Valor                |
|------------|----------------------|
| Status     | Aceito               |
| Data       | 2026-01-17           |
| Autor      | Ar√£o Freitas         |

## Contexto

O sistema tem dois tipos distintos de workloads:

1. **Processamento pesado** (Split/Print de v√≠deo):
   - Dura√ß√£o: 20s-5min por segmento
   - CPU/RAM intensivo (FFmpeg)
   - Uso de disco para arquivos tempor√°rios
   - Sem limite de tempo

2. **Notifica√ß√µes leves** (Email/SMS):
   - Dura√ß√£o: 100-500ms
   - Event-driven
   - Stateless
   - Escala autom√°tica

A pergunta central: **Lambda ou Kubernetes Workers?**

## Decis√£o

Adotar arquitetura simplificada com Spot Instances:

| Workload | Solu√ß√£o | Justificativa |
|----------|---------|---------------|
| **Split/Print** | KEDA Worker + K8s Jobs + **Spot** | Processamento longo, FFmpeg, sem limite de tempo, 85% economia |
| **Notifica√ß√µes** | **SES Templates + API Destination** | Zero compute, s√≥ SES, m√°xima simplicidade |

### Arquitetura

```mermaid
flowchart TB
    EB[EventBridge]

    EB --> APIDest1[API Destination<br/>Status Update]
    EB --> SQS[SQS Split/Print]
    EB --> APIDest2[API Destination<br/>SES Email]

    APIDest1 --> API[FIAPX API<br/>Cassandra]
    SQS --> KEDA[KEDA Worker<br/>FFmpeg + Spot]
    APIDest2 --> SES[SES<br/>Templates]
```

> **Sem Lambda**: Notifica√ß√µes via SES Templates + API Destination.
> Zero compute. S√≥ paga pelo envio de email ($0.10/1000).

## Comparativo de Custos (10.000 v√≠deos/m√™s)

### Processamento Split/Print

| M√©trica | Lambda | KEDA Worker (Spot) |
|---------|--------|---------------------|
| **Limite de tempo** | 15 min | Ilimitado |
| **RAM m√°ximo** | 10GB | Configur√°vel |
| **Custo/10k v√≠deos** | ~$833 | **~$0.50** |
| **Economia** | - | **99.9%** |

#### C√°lculo Lambda (2GB RAM, 30s avg)
```
Requests: 10.000 √ó 100 partes = 1M requests
Duration: 1M √ó 30s √ó 2GB = 60M GB-s
Custo: (1M √ó $0.20/M) + (60M √ó $0.0000166667) = $0.20 + $1000 ‚âà $1000

Nota: FFmpeg requer 2-4GB RAM para processamento de v√≠deo.
      256MB √© insuficiente para workloads reais.
```

#### C√°lculo KEDA + Spot Instance (c6a.large, 20s/job)
```
Jobs: 10.000 segmentos
Tempo: 10.000 √ó 20s = 55.5h
Custo On-Demand: 55.5h √ó $0.068/h = $3.78
Custo Spot (85% desconto): 55.5h √ó $0.010/h ‚âà $0.56

Nota: Spot Instances oferecem 70-90% de desconto.
      Jobs s√£o idempotentes ‚Äî interrup√ß√£o = reprocessa via SQS.
```

### Notifica√ß√µes Email

| M√©trica | Lambda + SES | SES Templates + API Dest |
|---------|--------------|--------------------------|
| **Custo/10k notifica√ß√µes** | $0.51 | **$0.10** |
| **Compute** | Lambda ARM | **Zero** |
| **Infra** | Lambda + SNS + SES | S√≥ EventBridge + SES |
| **Flexibilidade** | Alta | M√©dia |
| **Economia** | - | **80%** |

#### C√°lculo SES Templates (sem Lambda)
```
Emails: 30.000 (3 emails/v√≠deo: quase l√°, conclu√≠do, ou falha)
Custo SES: 30k √ó $0.0001 = $0.30
EventBridge: 30k eventos √ó $1/M = $0.03
API Destination: Gr√°tis (primeiros 5M/m√™s)

Total: ~$0.33/m√™s

Nota: Zero compute. Zero Lambda. Zero cold start.
```

#### Templates Utilizados
- **VideoQuaseFinalizado**: Enviado quando status = SPLITTING
- **VideoConcluido**: Enviado quando status = COMPLETED
- **VideoFalhou**: Enviado quando status = FAILED

## Consequ√™ncias

### Positivas

- **Custo m√≠nimo**: ~$1/m√™s vs ~$1000/m√™s (99% economia)
- **Zero Lambda**: Notifica√ß√µes sem compute, s√≥ SES Templates
- **Performance adequada**: Cada workload com runtime ideal
- **Escalabilidade**: KEDA escala baseado em SQS, SES escala automaticamente
- **Resili√™ncia**: Jobs idempotentes + SQS visibility timeout = retry autom√°tico
- **Spot-friendly**: Interrup√ß√µes n√£o causam perda de dados
- **Infra simplificada**: Menos servi√ßos para manter

### Negativas

- Monitoramento em dois lugares (CloudWatch + Prometheus/Grafana)
- Deploy K8s mais complexo que serverless puro
- Scale 0‚Üí1 pod leva 5-30s (aceit√°vel para jobs de 20s+)
- Templates SES limitados (sem l√≥gica condicional complexa)

## Configura√ß√£o KEDA + Spot

### ScaledObject
```yaml
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: split-worker
spec:
  scaleTargetRef:
    name: split-worker
  minReplicaCount: 0  # Scale to zero quando idle
  maxReplicaCount: 10
  cooldownPeriod: 300  # 5min antes de scale down
  triggers:
    - type: aws-sqs-queue
      metadata:
        queueURL: https://sqs.us-east-1.amazonaws.com/123456789/split-queue
        queueLength: "5"
        awsRegion: us-east-1
```

### Node Group Spot (EKS)
```yaml
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig
metadata:
  name: fiapx-cluster
  region: us-east-1
managedNodeGroups:
  - name: spot-workers
    instanceTypes: [c6a.large, c5a.large, c5.large]  # Diversifica√ß√£o
    spot: true
    minSize: 0
    maxSize: 10
    labels:
      workload: video-processing
    taints:
      - key: spot
        value: "true"
        effect: NoSchedule
```

### Tolerations no Worker
```yaml
tolerations:
  - key: spot
    operator: Equal
    value: "true"
    effect: NoSchedule
nodeSelector:
  workload: video-processing
```

> **Nota sobre Spot**: Interrup√ß√µes s√£o mitigadas por:
> - Jobs idempotentes (reprocessa o mesmo segmento)
> - SQS visibility timeout (mensagem volta para fila)
> - Diversifica√ß√£o de instance types (reduz chance de interrup√ß√£o)

## Configura√ß√£o SES Templates + API Destination

### Template SES (CloudFormation)
```yaml
VideoQuaseFinalizadoTemplate:
  Type: AWS::SES::Template
  Properties:
    Template:
      TemplateName: VideoQuaseFinalizado
      SubjectPart: "Seu v√≠deo est√° quase pronto! üé¨"
      HtmlPart: |
        <h1>Ol√° {{name}},</h1>
        <p>Seu v√≠deo <strong>"{{videoName}}"</strong> est√° quase pronto!</p>
        <p>Estamos finalizando o processamento. Voc√™ receber√° outro email quando estiver dispon√≠vel.</p>
        <p>Status: Gerando imagens (~80%)</p>

VideoConcluidoTemplate:
  Type: AWS::SES::Template
  Properties:
    Template:
      TemplateName: VideoConcluido
      SubjectPart: "Seu v√≠deo est√° pronto! ‚úÖ"
      HtmlPart: |
        <h1>Ol√° {{name}},</h1>
        <p>Seu v√≠deo <strong>"{{videoName}}"</strong> foi processado com sucesso!</p>
        <p><a href="{{downloadUrl}}">Clique aqui para download</a></p>
        <p>O link expira em 7 dias.</p>
```

### EventBridge Rule + API Destination
```yaml
NotificationRule:
  Type: AWS::Events::Rule
  Properties:
    EventPattern:
      source: ["fiapx.video"]
      detail-type: ["Video Status Changed"]
      detail:
        status: ["SPLITTING", "COMPLETED", "FAILED"]
    Targets:
      - Id: ses-api-destination
        Arn: !GetAtt SESApiDestination.Arn
        RoleArn: !GetAtt EventBridgeRole.Arn
        InputTransformer:
          InputPathsMap:
            email: "$.detail.userEmail"
            name: "$.detail.userName"
            videoName: "$.detail.videoName"
            status: "$.detail.status"
            downloadUrl: "$.detail.downloadUrl"
          InputTemplate: |
            {
              "Destination": {"ToAddresses": ["<email>"]},
              "Content": {
                "Template": {
                  "TemplateName": "<status>",
                  "TemplateData": "{\"name\":\"<name>\",\"videoName\":\"<videoName>\",\"downloadUrl\":\"<downloadUrl>\"}"
                }
              }
            }

SESApiDestination:
  Type: AWS::Events::ApiDestination
  Properties:
    ConnectionArn: !GetAtt SESConnection.Arn
    HttpMethod: POST
    InvocationEndpoint: https://email.us-east-1.amazonaws.com/v2/email/outbound-emails
    InvocationRateLimitPerSecond: 10
```

## Alternativas Consideradas

1. **Lambda para tudo**: Descartado por limite de 15min e custo ~1000x maior para processamento pesado
2. **Lambda para notifica√ß√µes**: Funciona, mas overkill para templates simples
3. **KEDA para tudo**: Descartado por overhead de pods para workloads curtos
4. **ECS Fargate**: Descartado por custo maior que KEDA e menos flexibilidade
5. **On-Demand em vez de Spot**: Funciona, mas 10x mais caro sem benef√≠cio
6. **Pinpoint**: Mais features (segmenta√ß√£o, m√©tricas), mas mais caro e complexo

## Otimiza√ß√µes Futuras

| Otimiza√ß√£o | Economia | Quando Considerar |
|------------|----------|-------------------|
| **Graviton (ARM)** | +20-40% | Se FFmpeg build suportar ARM |
| **GPU Spot (g4dn)** | Vari√°vel | V√≠deos longos, H.265/AV1, alto volume |
| **Karpenter** | Ops overhead | Substituir Cluster Autoscaler |

## Refer√™ncias

- [AWS Lambda Pricing](https://aws.amazon.com/lambda/pricing/)
- [EC2 Spot Instances](https://aws.amazon.com/ec2/spot/)
- [EC2 Spot Best Practices](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-best-practices.html)
- [SES Email Templates](https://docs.aws.amazon.com/ses/latest/dg/send-personalized-email-api.html)
- [EventBridge API Destinations](https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-api-destinations.html)
- [FinOps: Containers vs Serverless](https://aws.amazon.com/blogs/aws-cloud-financial-management/a-finops-guide-to-comparing-containers-and-serverless-functions-for-compute/)
- [KEDA SQS Scaler](https://keda.sh/docs/2.12/scalers/aws-sqs/)
- [AWS Well-Architected: Cost Optimization](https://docs.aws.amazon.com/wellarchitected/latest/cost-optimization-pillar/welcome.html)
