# ADR 008 — Arquitetura Híbrida: KEDA Workers + Lambda

| Campo      | Valor                |
|------------|----------------------|
| Status     | Aceito               |
| Data       | 2026-01-17           |
| Autor      | Arão Freitas         |

## Contexto

O sistema tem dois tipos distintos de workloads:

1. **Processamento pesado** (Split/Print de vídeo):
   - Duração: 20s-5min por segmento
   - CPU/RAM intensivo (FFmpeg)
   - Uso de disco para arquivos temporários
   - Sem limite de tempo

2. **Notificações leves** (Email/SMS):
   - Duração: 100-500ms
   - Event-driven
   - Stateless
   - Escala automática

A pergunta central: **Lambda ou Kubernetes Workers?**

## Decisão

Adotar arquitetura híbrida:

| Workload | Solução | Justificativa |
|----------|---------|---------------|
| **Split/Print** | KEDA Worker + K8s Jobs | Processamento longo, FFmpeg, sem limite de tempo |
| **Notificações** | Lambda | Event-driven, curto, escala automática |

### Arquitetura

```
                    ┌─────────────────────────────────────────┐
                    │              EventBridge                │
                    └─────────────┬───────────────────────────┘
                                  │
              ┌───────────────────┼───────────────────┐
              ▼                   ▼                   ▼
    ┌─────────────────┐  ┌───────────────┐  ┌───────────────┐
    │ API Destination │  │  SQS Split    │  │    SNS        │
    │ (Status Update) │  │  SQS Print    │  │ (Fanout)      │
    └─────────────────┘  └───────┬───────┘  └───────┬───────┘
              │                  │                  │
              ▼                  ▼                  ▼
    ┌─────────────────┐  ┌───────────────┐  ┌───────────────┐
    │   FIAPX API     │  │ KEDA Worker   │  │    Lambda     │
    │   (Cassandra)   │  │ (FFmpeg Job)  │  │ (Email/SMS)   │
    └─────────────────┘  └───────────────┘  └───────────────┘
```

## Comparativo de Custos (10.000 vídeos/mês)

### Processamento Split/Print

| Métrica | Lambda | KEDA Worker |
|---------|--------|-------------|
| **Limite de tempo** | 15 min | Ilimitado |
| **RAM máximo** | 10GB | Configurável |
| **Cold Start** | 100ms-3s | 0ms (pods pré-aquecidos) |
| **Custo/10k vídeos** | $85.33 | $3.80 |
| **Economia** | - | **95%** |

#### Cálculo Lambda (256MB, 30s avg)
```
Requests: 10.000 × 100 partes = 1M requests
Duration: 1M × 30s × 0.25GB = 7.5M GB-s
Custo: (1M × $0.20/M) + (7.5M × $0.0000166667) = $0.20 + $125 = $125.20
```

#### Cálculo KEDA (c6a.large, 20s/job)
```
Jobs: 10.000 segmentos
Tempo: 10.000 × 20s = 55.5h
Custo: 55.5h × $0.068/h = $3.78
```

### Notificações Email/SMS

| Métrica | Lambda | KEDA Worker |
|---------|--------|-------------|
| **Custo/10k notificações** | $0.50 | $15.00 |
| **Cold Start** | Aceitável (100ms) | 0ms |
| **Escala** | Automática | Manual |
| **Economia** | **97%** | - |

#### Cálculo Lambda (128MB ARM, 200ms avg)
```
Requests: 20.000 (email + SMS)
Duration: 20.000 × 0.2s × 0.125GB = 500 GB-s
Custo: (20k × $0.20/M) + (500 × $0.0000133334) = $0.004 + $0.007 = ~$0.01
+ SNS: $0.50
Total: ~$0.51
```

## Consequências

### Positivas

- **Custo otimizado**: ~$5/mês vs ~$140/mês (96% economia)
- **Performance adequada**: Cada workload com runtime ideal
- **Escalabilidade**: KEDA escala baseado em SQS, Lambda escala automaticamente
- **Resiliência**: Retry/DLQ em ambos os casos

### Negativas

- Duas stacks de runtime para manter (K8s + Lambda)
- Monitoramento em dois lugares (CloudWatch + Prometheus/Grafana)
- Deploy mais complexo

## Configuração KEDA

```yaml
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: split-worker
spec:
  scaleTargetRef:
    name: split-worker
  minReplicaCount: 0
  maxReplicaCount: 10
  triggers:
    - type: aws-sqs-queue
      metadata:
        queueURL: https://sqs.us-east-1.amazonaws.com/123456789/split-queue
        queueLength: "5"
        awsRegion: us-east-1
```

## Configuração Lambda

```yaml
# SAM Template
EmailNotificationFunction:
  Type: AWS::Serverless::Function
  Properties:
    Handler: index.handler
    Runtime: nodejs20.x
    Architectures: [arm64]
    MemorySize: 128
    Timeout: 30
    Events:
      SNSEvent:
        Type: SNS
        Properties:
          Topic: !Ref PrintCompletedTopic
```

## Alternativas Consideradas

1. **Lambda para tudo**: Descartado por limite de 15min e custo alto para processamento pesado
2. **KEDA para tudo**: Descartado por overhead de pods para workloads curtos
3. **ECS Fargate**: Descartado por custo maior que KEDA e menos flexibilidade

## Referências

- [AWS Lambda Pricing](https://aws.amazon.com/lambda/pricing/)
- [FinOps: Containers vs Serverless](https://aws.amazon.com/blogs/aws-cloud-financial-management/a-finops-guide-to-comparing-containers-and-serverless-functions-for-compute/)
- [KEDA SQS Scaler](https://keda.sh/docs/2.12/scalers/aws-sqs/)
- [AWS Well-Architected: Cost Optimization](https://docs.aws.amazon.com/wellarchitected/latest/cost-optimization-pillar/welcome.html)
