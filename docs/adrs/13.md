# ADR 013 — Arquivamento de Vídeos Raw em S3 Glacier Instant Retrieval

| Campo      | Valor                |
|------------|----------------------|
| Status     | Aceito             |
| Data       | 2026-01-27           |
| Autor      | Arão Freitas         |

## Contexto

Após o processamento de um vídeo (extração de prints), o arquivo raw de 1GB permanece no S3 Standard a $0.023/GB/mês. Esse vídeo original raramente é acessado pelo usuário após o processamento, mas precisa estar disponível para:

1. Download eventual pelo usuário (vídeo original)
2. Reprocessamento em caso de erro
3. Auditoria e compliance

Manter 10.000 vídeos de 1GB em S3 Standard custa ~$230/mês (~$2,760/ano).

## Decisão

Transicionar vídeos raw para **S3 Glacier Instant Retrieval** após a conclusão do processamento, utilizando o evento `COMPLETED` já existente no sistema.

### Fluxo de Arquivamento

```
PrintWorker (último segmento)
       ↓
   ┌───┴───┐
   ↓       ↓
S3 Tag    EventBridge: COMPLETED
   ↓             ↓
Lifecycle      SES (email)
   ↓
Glacier IR
```

O próprio `PrintWorker` aplica a tag no momento do `COMPLETED`, aproveitando que já possui cliente S3 configurado. Zero componentes adicionais.

### Configuração do Lifecycle

```yaml
Rules:
  - ID: "archive-processed-videos"
    Filter:
      And:
        Prefix: "videos/raw/"
        Tags:
          - Key: "archive-status"
            Value: "ready"
    Status: Enabled
    Transitions:
      - Days: 0
        StorageClass: GLACIER_IR
```

### Por que Glacier Instant Retrieval?

| Critério | Glacier IR | Deep Archive |
|----------|------------|--------------|
| Acesso | Imediato (ms) | 12-48 horas |
| Storage | $0.004/GB | $0.00099/GB |
| Retrieval | $0.03/GB | $0.02/GB |
| Mínimo | 90 dias | 180 dias |
| UX Download | ✅ Transparente | ❌ Espera horas |

Glacier Instant Retrieval permite que o usuário baixe o vídeo original **imediatamente**, sem mudança na experiência. Presigned URLs funcionam normalmente.

## Consequências

### Positivas

- **Economia de 83%** em storage (~$2,200/ano para 10k vídeos)
- **Zero mudança no código** de download (presigned URLs funcionam igual)
- **Acesso imediato** mantém UX do usuário
- **Evento já existe** (`COMPLETED` emitido pelo PrintWorker)
- **Retenção do original** para auditoria/reprocessamento

### Negativas

- **Custo de retrieval**: $0.03/GB quando usuário baixa
- **Mínimo 90 dias**: Deletar antes incorre em custo proporcional
- **Requests mais caros**: $0.01/1000 GET vs $0.0004 do Standard

### Análise de Break-even

```
Custo Standard:   $0.023/GB/mês (retrieval grátis)
Custo Glacier IR: $0.004/GB/mês + $0.03/GB × % downloads

Break-even: 63% de downloads/mês
```

| % Downloads | Standard | Glacier IR | Economia |
|-------------|----------|------------|----------|
| 5% | $0.023 | $0.0055 | 76% |
| 10% | $0.023 | $0.007 | 70% |
| 30% | $0.023 | $0.013 | 43% |
| 63% | $0.023 | $0.023 | 0% |

**Para menos de 63% de downloads, Glacier IR é mais econômico.**

## Implementação

### 1. PrintWorker Aplica Tag (Zero Lambda)

O `PrintWorker` já detecta quando é o último segmento. Basta adicionar a chamada de tagging:

```typescript
// workers/src/print-worker.ts
import { S3Client, PutObjectTaggingCommand } from '@aws-sdk/client-s3'

// No bloco if (isLastSegment):
if (isLastSegment) {
  // Aplicar tag para arquivamento
  await this.tagForArchive(videoId, rawVideoKey)

  // Emitir evento de conclusão (já existente)
  await this.emitStatusEvent(videoId, 'COMPLETED', ...)
}

private async tagForArchive(videoId: string, rawVideoKey: string): Promise<void> {
  await this.s3Client.send(new PutObjectTaggingCommand({
    Bucket: this.rawVideoBucket,
    Key: rawVideoKey,
    Tagging: {
      TagSet: [
        { Key: 'archive-status', Value: 'ready' },
        { Key: 'processed-at', Value: new Date().toISOString() },
        { Key: 'video-id', Value: videoId },
      ],
    },
  }))

  this.logger.log(`[PRINT] Tagged video for archive: ${rawVideoKey}`)
}
```

**Vantagens sobre Lambda:**
- Zero componentes adicionais
- Zero latência extra (já está no fluxo)
- Zero custo adicional
- Menor superfície de erro

### 2. S3 Lifecycle Policy

```json
{
  "Rules": [
    {
      "ID": "archive-processed-videos",
      "Filter": {
        "And": {
          "Prefix": "videos/raw/",
          "Tags": [
            { "Key": "archive-status", "Value": "ready" }
          ]
        }
      },
      "Status": "Enabled",
      "Transitions": [
        {
          "Days": 0,
          "StorageClass": "GLACIER_IR"
        }
      ]
    }
  ]
}
```

## Custos Estimados

### Cenário: 10.000 vídeos de 1GB/mês, 5% downloads

| Componente | Standard | Com Glacier IR |
|------------|----------|----------------|
| Storage (12 meses) | $2,760 | $480 |
| Retrieval (5% × 12) | $0 | $180 |
| Tagging (PrintWorker) | $0 | $0 |
| **Total Anual** | **$2,760** | **$660** |
| **Economia** | - | **$2,100 (76%)** |

## Alternativas Consideradas

### 1. Deletar vídeo após processamento

**Descartado**: Sem possibilidade de reprocessamento ou download do original.

### 2. S3 Glacier Deep Archive

**Descartado**: Retrieval de 12-48h inviabiliza download pelo usuário.

### 3. S3 Glacier Flexible Retrieval

**Descartado**: Retrieval de 1-12h ainda impacta UX do usuário.

### 4. S3 Intelligent-Tiering

**Considerado**: Alternativa válida, mas menos controle sobre quando a transição ocorre. Glacier IR com tag explícita é mais previsível.

### 5. Lifecycle baseada em tempo (sem evento)

**Descartado**: Poderia arquivar vídeos ainda em processamento se houver atraso.

### 6. Lambda via EventBridge para aplicar tag

**Descartado**: Adiciona componente desnecessário. O PrintWorker já está no contexto do COMPLETED e possui cliente S3 configurado. Aplicar a tag diretamente é mais simples, rápido e sem custo adicional.

## Métricas de Sucesso

| Métrica | Atual | Esperado |
|---------|-------|----------|
| Custo storage/mês | $230 | $40 |
| Latência download | ~50ms | ~50ms (igual) |
| % vídeos arquivados | 0% | 100% após 24h |

## Referências

- [S3 Glacier Instant Retrieval](https://aws.amazon.com/s3/storage-classes/glacier/instant-retrieval/)
- [S3 Lifecycle Configuration](https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lifecycle-mgmt.html)
- [S3 Object Tagging](https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-tagging.html)
- [EventBridge S3 Integration](https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-service-event.html)
