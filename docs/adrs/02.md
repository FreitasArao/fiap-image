# ADR 002 — EventBridge + SQS para Eventos S3

| Campo      | Valor                |
|------------|----------------------|
| Status     | Aceito               |
| Data       | 2026-01-16           |
| Autor      | Arão Freitas         |

## Contexto

O sistema precisa detectar quando um upload multipart é finalizado para disparar o processamento do vídeo. Lambda como handler de eventos adiciona cold starts e custo por execução.

### Limitação do S3

**IMPORTANTE**: O S3 **NÃO emite eventos para cada parte individual** (`UploadPart`).

Eventos disponíveis via EventBridge:

| Evento S3 | Disponível? |
|-----------|-------------|
| `UploadPart` | **NÃO** |
| `CompleteMultipartUpload` | **SIM** (Object Created) |
| `AbortMultipartUpload` | **NÃO** |

Fonte: [S3 Event Notifications to EventBridge](https://docs.aws.amazon.com/AmazonS3/latest/userguide/EventBridge.html)

## Decisão

Usar EventBridge + SQS para rotear eventos S3 `CompleteMultipartUpload` para processamento:

```
S3 (CompleteMultipartUpload)
    ↓
EventBridge (Object Created)
    ↓
SQS Queue
    ↓
KEDA Worker → FFmpeg Job
```

### Por que SQS e não API Destination direto?

| Critério | API Destination | SQS |
|----------|-----------------|-----|
| Timeout | 30s (limite) | Ilimitado |
| Backpressure | Não | Sim (buffer) |
| Retry | 5 tentativas | Configurável |
| DLQ | Sim | Sim |
| Uso ideal | Updates leves | Processamento pesado |

Para processamento de vídeo (pode levar minutos), SQS é mais adequado.

## Consequências

### Positivas

- **Sem cold starts**: SQS + KEDA Worker não tem cold start
- **Buffer para picos**: SQS absorve carga
- **Retry robusto**: Configuração flexível de retries
- **DLQ nativo**: Mensagens com falha vão para DLQ
- **Custo baixo**: ~$0.05/mês para 10k vídeos

### Negativas

- Requer configuração de regras no EventBridge
- Mais componentes (EventBridge + SQS + KEDA)
- Latência adicional vs invocação direta (~100ms)

## Alternativas Consideradas

1. **Lambda como handler**: Descartado por cold starts, limite de 15min e custo por execução (~$0.20/1M invocações + tempo de execução)
2. **API Destination direto**: Descartado por timeout de 30s insuficiente para processamento de vídeo
3. **S3 Event Notification direto para SQS**: Descartado por menor flexibilidade de filtros comparado a EventBridge

## Regra EventBridge

```json
{
  "source": ["aws.s3"],
  "detail-type": ["Object Created"],
  "detail": {
    "bucket": { "name": ["fiapx-videos"] },
    "reason": ["CompleteMultipartUpload"]
  }
}
```

## Referências

- [S3 Event Notifications to EventBridge](https://docs.aws.amazon.com/AmazonS3/latest/userguide/EventBridge.html)
- [Amazon EventBridge Rules](https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-rules.html)
- [EventBridge Event Patterns](https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-event-patterns.html)
- [Amazon SQS](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/welcome.html)
