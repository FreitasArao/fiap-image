services:
  database:
    image: cassandra:4.1
    container_name: cassandra
    ports:
      - "9042:9042"
    environment:
      - CASSANDRA_CLUSTER_NAME=fiap-image
      - CASSANDRA_DC=datacenter1
      - CASSANDRA_RACK=rack1
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
    volumes:
      - cassandra-data:/var/lib/cassandra
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'describe keyspaces' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 40s

  db-init:
    image: cassandra:4.1
    container_name: cassandra-init
    depends_on:
      database:
        condition: service_healthy
    volumes:
      - ./init-schema.cql:/init-schema.cql:ro
    entrypoint:
      - bash
      - -c
      - |
        cqlsh database -f /init-schema.cql
    restart: "no"

  database-admin:
    image: ipushc/cassandra-web:latest
    container_name: cassandra-admin
    ports:
      - "8083:8083"
    environment:
      - CASSANDRA_HOST=database
      - CASSANDRA_PORT=9042
    depends_on:
      database:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully

volumes:
  cassandra-data:
