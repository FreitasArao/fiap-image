services:
  localstack:
    image: localstack/localstack:3.8.1
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3,events,sqs,sns,ses
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - DEBUG=0
      - LOCALSTACK_HOST=localhost.localstack.cloud
      - EXTRA_CORS_ALLOWED_ORIGINS=https://app.localstack.cloud
      - DISABLE_CORS_CHECKS=1
      - SQS_DISABLE_CLOUDWATCH_METRICS=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  localstack-init:
    container_name: localstack-init
    image: amazon/aws-cli:latest
    depends_on:
      localstack:
        condition: service_healthy
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    entrypoint: /bin/sh
    command:
      - -c
      - |
        set -e

        # ============================================
        # S3 BUCKETS
        # ============================================
        echo "=== Criando buckets ==="
        aws --endpoint-url=http://localstack:4566 s3 mb s3://fiapx-video-parts || true
        aws --endpoint-url=http://localstack:4566 s3 mb s3://fiapx-video-frames || true

        echo "=== Configurando CORS nos buckets ==="
        aws --endpoint-url=http://localstack:4566 s3api put-bucket-cors \
          --bucket fiapx-video-parts \
          --cors-configuration '{
            "CORSRules": [
              {
                "AllowedHeaders": ["*"],
                "AllowedMethods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
                "AllowedOrigins": ["*"],
                "ExposeHeaders": ["ETag", "x-amz-meta-custom-header"],
                "MaxAgeSeconds": 3600
              }
            ]
          }'

        aws --endpoint-url=http://localstack:4566 s3api put-bucket-cors \
          --bucket fiapx-video-frames \
          --cors-configuration '{
            "CORSRules": [
              {
                "AllowedHeaders": ["*"],
                "AllowedMethods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
                "AllowedOrigins": ["*"],
                "ExposeHeaders": ["ETag", "x-amz-meta-custom-header"],
                "MaxAgeSeconds": 3600
              }
            ]
          }'

        echo "=== Habilitando EventBridge no bucket ==="
        aws --endpoint-url=http://localstack:4566 s3api put-bucket-notification-configuration \
          --bucket fiapx-video-parts \
          --notification-configuration '{ "EventBridgeConfiguration": {} }'

        # ============================================
        # SQS QUEUES
        # ============================================
        echo "=== Criando filas SQS ==="

        # Fila para eventos S3 CompleteMultipartUpload
        aws --endpoint-url=http://localstack:4566 sqs create-queue \
          --queue-name multipart-complete-queue \
          --attributes '{
            "VisibilityTimeout": "120",
            "MessageRetentionPeriod": "86400"
          }'

        # Fila para orquestracao (calcula segmentos e despacha para print-queue)
        aws --endpoint-url=http://localstack:4566 sqs create-queue \
          --queue-name orchestrator-queue \
          --attributes '{
            "VisibilityTimeout": "300",
            "MessageRetentionPeriod": "86400"
          }'

        # Fila para processamento de print/frames (FFmpeg)
        aws --endpoint-url=http://localstack:4566 sqs create-queue \
          --queue-name print-queue \
          --attributes '{
            "VisibilityTimeout": "600",
            "MessageRetentionPeriod": "86400"
          }'

        # Fila para notificacoes (e-mail via SES)
        aws --endpoint-url=http://localstack:4566 sqs create-queue \
          --queue-name notification-queue \
          --attributes '{
            "VisibilityTimeout": "60",
            "MessageRetentionPeriod": "86400"
          }'

        # DLQ para mensagens com falha
        aws --endpoint-url=http://localstack:4566 sqs create-queue \
          --queue-name processing-dlq

        # ============================================
        # SNS TOPICS (Fan-out: EventBridge -> SNS -> SQS)
        # ============================================
        echo "=== Criando topicos SNS ==="

        aws --endpoint-url=http://localstack:4566 sns create-topic \
          --name multipart-complete-topic

        aws --endpoint-url=http://localstack:4566 sns create-topic \
          --name video-uploaded-topic

        aws --endpoint-url=http://localstack:4566 sns create-topic \
          --name video-notification-topic

        # ============================================
        # SNS -> SQS SUBSCRIPTIONS (Raw Message Delivery)
        # ============================================
        echo "=== Criando subscriptions SNS -> SQS ==="

        # multipart-complete-topic -> multipart-complete-queue
        aws --endpoint-url=http://localstack:4566 sns subscribe \
          --topic-arn arn:aws:sns:us-east-1:000000000000:multipart-complete-topic \
          --protocol sqs \
          --notification-endpoint arn:aws:sqs:us-east-1:000000000000:multipart-complete-queue \
          --attributes '{"RawMessageDelivery": "true"}'

        # video-uploaded-topic -> orchestrator-queue
        aws --endpoint-url=http://localstack:4566 sns subscribe \
          --topic-arn arn:aws:sns:us-east-1:000000000000:video-uploaded-topic \
          --protocol sqs \
          --notification-endpoint arn:aws:sqs:us-east-1:000000000000:orchestrator-queue \
          --attributes '{"RawMessageDelivery": "true"}'

        # video-notification-topic -> notification-queue
        aws --endpoint-url=http://localstack:4566 sns subscribe \
          --topic-arn arn:aws:sns:us-east-1:000000000000:video-notification-topic \
          --protocol sqs \
          --notification-endpoint arn:aws:sqs:us-east-1:000000000000:notification-queue \
          --attributes '{"RawMessageDelivery": "true"}'

        # ============================================
        # SQS PERMISSIONS (permitir SNS enviar mensagens)
        # ============================================
        echo "=== Configurando permissao das filas para SNS ==="

        aws --endpoint-url=http://localstack:4566 sqs set-queue-attributes \
          --queue-url http://localstack:4566/000000000000/multipart-complete-queue \
          --attributes '{
            "Policy": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"sns.amazonaws.com\"},\"Action\":\"sqs:SendMessage\",\"Resource\":\"arn:aws:sqs:us-east-1:000000000000:multipart-complete-queue\",\"Condition\":{\"ArnEquals\":{\"aws:SourceArn\":\"arn:aws:sns:us-east-1:000000000000:multipart-complete-topic\"}}}]}"
          }'

        aws --endpoint-url=http://localstack:4566 sqs set-queue-attributes \
          --queue-url http://localstack:4566/000000000000/orchestrator-queue \
          --attributes '{
            "Policy": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"sns.amazonaws.com\"},\"Action\":\"sqs:SendMessage\",\"Resource\":\"arn:aws:sqs:us-east-1:000000000000:orchestrator-queue\",\"Condition\":{\"ArnEquals\":{\"aws:SourceArn\":\"arn:aws:sns:us-east-1:000000000000:video-uploaded-topic\"}}}]}"
          }'

        aws --endpoint-url=http://localstack:4566 sqs set-queue-attributes \
          --queue-url http://localstack:4566/000000000000/notification-queue \
          --attributes '{
            "Policy": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"sns.amazonaws.com\"},\"Action\":\"sqs:SendMessage\",\"Resource\":\"arn:aws:sqs:us-east-1:000000000000:notification-queue\",\"Condition\":{\"ArnEquals\":{\"aws:SourceArn\":\"arn:aws:sns:us-east-1:000000000000:video-notification-topic\"}}}]}"
          }'

        # ============================================
        # EVENTBRIDGE RULES
        # ============================================
        echo "=== Criando EventBridge rules ==="

        # Rule 1: S3 CompleteMultipartUpload -> multipart-complete-topic
        aws --endpoint-url=http://localstack:4566 events put-rule \
          --name multipart-complete-rule \
          --event-pattern '{
            "source": ["aws.s3"],
            "detail-type": ["Object Created"],
            "detail": {
              "bucket": { "name": ["fiapx-video-parts"] },
              "reason": ["CompleteMultipartUpload"]
            }
          }'

        # Rule 2: Video UPLOADED -> video-uploaded-topic
        # Detail contains envelope { metadata, payload } so status is at payload.status
        aws --endpoint-url=http://localstack:4566 events put-rule \
          --name video-uploaded-rule \
          --event-pattern '{
            "source": ["fiapx.video"],
            "detail-type": ["Video Status Changed"],
            "detail": {
              "payload": {
                "status": ["UPLOADED"]
              }
            }
          }'

        # Rule 3: Video PROCESSING/COMPLETED/FAILED -> video-notification-topic
        # Detail contains envelope { metadata, payload } so status is at payload.status
        aws --endpoint-url=http://localstack:4566 events put-rule \
          --name video-notification-rule \
          --event-pattern '{
            "source": ["fiapx.video"],
            "detail-type": ["Video Status Changed"],
            "detail": {
              "payload": {
                "status": ["PROCESSING", "COMPLETED", "FAILED"]
              }
            }
          }'

        # ============================================
        # EVENTBRIDGE TARGETS (-> SNS Topics)
        # ============================================
        echo "=== Configurando targets do EventBridge (-> SNS) ==="

        # Target: S3 CompleteMultipart -> multipart-complete-topic
        aws --endpoint-url=http://localstack:4566 events put-targets \
          --rule multipart-complete-rule \
          --targets '[
            {
              "Id": "multipart-complete-sns-target",
              "Arn": "arn:aws:sns:us-east-1:000000000000:multipart-complete-topic"
            }
          ]'

        # Target: Video UPLOADED -> video-uploaded-topic
        aws --endpoint-url=http://localstack:4566 events put-targets \
          --rule video-uploaded-rule \
          --targets '[
            {
              "Id": "video-uploaded-sns-target",
              "Arn": "arn:aws:sns:us-east-1:000000000000:video-uploaded-topic"
            }
          ]'

        # Target: Video PROCESSING/COMPLETED/FAILED -> video-notification-topic
        aws --endpoint-url=http://localstack:4566 events put-targets \
          --rule video-notification-rule \
          --targets '[
            {
              "Id": "video-notification-sns-target",
              "Arn": "arn:aws:sns:us-east-1:000000000000:video-notification-topic"
            }
          ]'

        # ============================================
        # SES (Email)
        # ============================================
        echo "=== Configurando SES ==="
        aws --endpoint-url=http://localstack:4566 ses verify-email-identity \
          --email-address noreply@fiapx.local

        aws --endpoint-url=http://localstack:4566 ses verify-email-identity \
          --email-address notifications@fiapx.local

        aws --endpoint-url=http://localstack:4566 ses verify-domain-identity \
          --domain fiapx.local

        # Criar templates de email
        echo "=== Criando templates SES ==="
        aws --endpoint-url=http://localstack:4566 ses create-template \
          --template '{
            "TemplateName": "VideoQuaseFinalizado",
            "SubjectPart": "Seu video esta quase pronto!",
            "HtmlPart": "<h1>Ola {{email}}</h1><p>Seu video <strong>{{videoName}}</strong> esta quase pronto!</p><p>Estamos gerando as imagens...</p>",
            "TextPart": "Ola {{email}}, seu video {{videoName}} esta quase pronto!"
          }' || true

        aws --endpoint-url=http://localstack:4566 ses create-template \
          --template '{
            "TemplateName": "VideoConcluido",
            "SubjectPart": "Seu video esta pronto!",
            "HtmlPart": "<h1>Ola {{email}}</h1><p>Seu video <strong>{{videoName}}</strong> foi processado!</p><p><a href=\"{{downloadUrl}}\">Clique aqui para download</a></p>",
            "TextPart": "Ola {{email}}, seu video {{videoName}} esta pronto! Download: {{downloadUrl}}"
          }' || true

        aws --endpoint-url=http://localstack:4566 ses create-template \
          --template '{
            "TemplateName": "VideoFalhou",
            "SubjectPart": "Erro ao processar seu video",
            "HtmlPart": "<h1>Ola {{email}}</h1><p>Houve um erro ao processar <strong>{{videoName}}</strong>.</p><p>Motivo: {{errorReason}}</p>",
            "TextPart": "Ola {{email}}, houve um erro ao processar {{videoName}}. Motivo: {{errorReason}}"
          }' || true

        # ============================================
        # LISTAGEM DE RECURSOS
        # ============================================
        echo "=== Listando recursos criados ==="
        echo "Filas SQS:"
        aws --endpoint-url=http://localstack:4566 sqs list-queues
        echo "Topicos SNS:"
        aws --endpoint-url=http://localstack:4566 sns list-topics
        echo "Subscriptions SNS:"
        aws --endpoint-url=http://localstack:4566 sns list-subscriptions
        echo "Rules EventBridge:"
        aws --endpoint-url=http://localstack:4566 events list-rules
        echo "Templates SES:"
        aws --endpoint-url=http://localstack:4566 ses list-templates

        echo "=== Setup concluido ==="
