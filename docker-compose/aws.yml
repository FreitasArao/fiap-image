services:
  localstack:
    image: localstack/localstack:3.8.1
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3,events,sqs,ses
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - DEBUG=0
      - LOCALSTACK_HOST=localhost.localstack.cloud
      - EXTRA_CORS_ALLOWED_ORIGINS=https://app.localstack.cloud
      - DISABLE_CORS_CHECKS=1
      - SQS_DISABLE_CLOUDWATCH_METRICS=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  localstack-init:
    container_name: localstack-init
    image: amazon/aws-cli:latest
    depends_on:
      localstack:
        condition: service_healthy
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    entrypoint: /bin/sh
    command:
      - -c
      - |
        set -e

        echo "=== Criando buckets ==="
        aws --endpoint-url=http://localstack:4566 s3 mb s3://fiapx-video-parts || true
        aws --endpoint-url=http://localstack:4566 s3 mb s3://fiapx-video-frames || true

        echo "=== Habilitando EventBridge no bucket ==="
        aws --endpoint-url=http://localstack:4566 s3api put-bucket-notification-configuration \
          --bucket fiapx-video-parts \
          --notification-configuration '{ "EventBridgeConfiguration": {} }'


        # Fila para processamento de split (FFmpeg)
        aws --endpoint-url=http://localstack:4566 sqs create-queue \
          --queue-name split-queue \
          --attributes '{
            "VisibilityTimeout": "300",
            "MessageRetentionPeriod": "86400"
          }'

        # Fila para processamento de print/frames (FFmpeg)
        aws --endpoint-url=http://localstack:4566 sqs create-queue \
          --queue-name print-queue \
          --attributes '{
            "VisibilityTimeout": "600",
            "MessageRetentionPeriod": "86400"
          }'

        # DLQ para mensagens com falha
        aws --endpoint-url=http://localstack:4566 sqs create-queue \
          --queue-name processing-dlq

        echo "=== Configurando permissao das filas para EventBridge ==="
        aws --endpoint-url=http://localstack:4566 sqs set-queue-attributes \
          --queue-url http://localstack:4566/000000000000/split-queue \
          --attributes '{
            "Policy": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"events.amazonaws.com\"},\"Action\":\"sqs:SendMessage\",\"Resource\":\"arn:aws:sqs:us-east-1:000000000000:split-queue\"}]}"
          }'

        aws --endpoint-url=http://localstack:4566 sqs set-queue-attributes \
          --queue-url http://localstack:4566/000000000000/print-queue \
          --attributes '{
            "Policy": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"events.amazonaws.com\"},\"Action\":\"sqs:SendMessage\",\"Resource\":\"arn:aws:sqs:us-east-1:000000000000:print-queue\"}]}"
          }'

        # EVENTBRIDGE RULES
        echo "=== Criando EventBridge rules ==="

        # Rule 1: S3 CompleteMultipartUpload -> multipart-complete-queue
        aws --endpoint-url=http://localstack:4566 events put-rule \
          --name multipart-complete-rule \
          --event-pattern '{
            "source": ["aws.s3"],
            "detail-type": ["Object Created"],
            "detail": {
              "bucket": { "name": ["fiapx-video-parts"] },
              "reason": ["CompleteMultipartUpload"]
            }
          }'

        # Rule 2: Video UPLOADED -> split-queue
        aws --endpoint-url=http://localstack:4566 events put-rule \
          --name video-uploaded-rule \
          --event-pattern '{
            "source": ["fiapx.video"],
            "detail-type": ["Video Status Changed"],
            "detail": {
              "status": ["UPLOADED"]
            }
          }'

        # Rule 3: Video SPLITTING -> print-queue
        aws --endpoint-url=http://localstack:4566 events put-rule \
          --name video-splitting-rule \
          --event-pattern '{
            "source": ["fiapx.video"],
            "detail-type": ["Video Status Changed"],
            "detail": {
              "status": ["SPLITTING"]
            }
          }'

        # Rule 4: Video status changes for notifications (SPLITTING, COMPLETED, FAILED)
        aws --endpoint-url=http://localstack:4566 events put-rule \
          --name video-notification-rule \
          --event-pattern '{
            "source": ["fiapx.video"],
            "detail-type": ["Video Status Changed"],
            "detail": {
              "status": ["SPLITTING", "COMPLETED", "FAILED"]
            }
          }'

        # ============================================
        # EVENTBRIDGE TARGETS
        # ============================================
        echo "=== Configurando targets do EventBridge ==="

        # ============================================
        # API DESTINATION para webhook S3 Complete
        # ============================================
        echo "=== Criando API Connection e Destination ==="

        # Criar Connection (autenticação básica dummy para LocalStack)
        aws --endpoint-url=http://localstack:4566 events create-connection \
          --name fiapx-api-connection \
          --authorization-type API_KEY \
          --auth-parameters '{"ApiKeyAuthParameters": {"ApiKeyName": "x-api-key", "ApiKeyValue": "localstack-dev"}}' || true

        # Criar API Destination
        aws --endpoint-url=http://localstack:4566 events create-api-destination \
          --name fiapx-s3-complete-webhook \
          --connection-arn arn:aws:events:us-east-1:000000000000:connection/fiapx-api-connection \
          --invocation-endpoint http://api:3010/videos/webhooks/s3/complete-multipart \
          --http-method POST \
          --invocation-rate-limit-per-second 10 || true

        # Target: S3 CompleteMultipart -> API Webhook
        aws --endpoint-url=http://localstack:4566 events put-targets \
          --rule multipart-complete-rule \
          --targets '[
            {
              "Id": "api-webhook-target",
              "Arn": "arn:aws:events:us-east-1:000000000000:api-destination/fiapx-s3-complete-webhook",
              "InputTransformer": {
                "InputPathsMap": {
                  "bucket": "$.detail.bucket.name",
                  "key": "$.detail.object.key"
                },
                "InputTemplate": "{\"bucket\": <bucket>, \"key\": <key>}"
              }
            }
          ]'

        # Target: Video UPLOADED -> split-queue
        aws --endpoint-url=http://localstack:4566 events put-targets \
          --rule video-uploaded-rule \
          --targets '[
            {
              "Id": "split-queue-target",
              "Arn": "arn:aws:sqs:us-east-1:000000000000:split-queue"
            }
          ]'

        # Target: Video SPLITTING -> print-queue
        aws --endpoint-url=http://localstack:4566 events put-targets \
          --rule video-splitting-rule \
          --targets '[
            {
              "Id": "print-queue-target",
              "Arn": "arn:aws:sqs:us-east-1:000000000000:print-queue"
            }
          ]'

        # ============================================
        # SES (Email)
        # ============================================
        echo "=== Configurando SES ==="
        aws --endpoint-url=http://localstack:4566 ses verify-email-identity \
          --email-address noreply@fiapx.local

        aws --endpoint-url=http://localstack:4566 ses verify-email-identity \
          --email-address notifications@fiapx.local

        aws --endpoint-url=http://localstack:4566 ses verify-domain-identity \
          --domain fiapx.local

        # Criar templates de email
        echo "=== Criando templates SES ==="
        aws --endpoint-url=http://localstack:4566 ses create-template \
          --template '{
            "TemplateName": "VideoQuaseFinalizado",
            "SubjectPart": "Seu video esta quase pronto!",
            "HtmlPart": "<h1>Ola {{email}}</h1><p>Seu video <strong>{{videoName}}</strong> esta quase pronto!</p><p>Estamos gerando as imagens...</p>",
            "TextPart": "Ola {{email}}, seu video {{videoName}} esta quase pronto!"
          }' || true

        aws --endpoint-url=http://localstack:4566 ses create-template \
          --template '{
            "TemplateName": "VideoConcluido",
            "SubjectPart": "Seu video esta pronto!",
            "HtmlPart": "<h1>Ola {{email}}</h1><p>Seu video <strong>{{videoName}}</strong> foi processado!</p><p><a href=\"{{downloadUrl}}\">Clique aqui para download</a></p>",
            "TextPart": "Ola {{email}}, seu video {{videoName}} esta pronto! Download: {{downloadUrl}}"
          }' || true

        aws --endpoint-url=http://localstack:4566 ses create-template \
          --template '{
            "TemplateName": "VideoFalhou",
            "SubjectPart": "Erro ao processar seu video",
            "HtmlPart": "<h1>Ola {{email}}</h1><p>Houve um erro ao processar <strong>{{videoName}}</strong>.</p><p>Motivo: {{errorReason}}</p>",
            "TextPart": "Ola {{email}}, houve um erro ao processar {{videoName}}. Motivo: {{errorReason}}"
          }' || true

        echo "=== Listando recursos criados ==="
        echo "Filas SQS:"
        aws --endpoint-url=http://localstack:4566 sqs list-queues
        echo "Rules EventBridge:"
        aws --endpoint-url=http://localstack:4566 events list-rules
        echo "Templates SES:"
        aws --endpoint-url=http://localstack:4566 ses list-templates

        echo "=== Setup concluido ==="
